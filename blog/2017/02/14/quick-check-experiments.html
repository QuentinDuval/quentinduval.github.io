<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.24.0 by Michael Rose
  Copyright 2013-2020 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>Experimenting with QuickCheck on a DSL - Double Ended Queue</title>
<meta name="description" content="After having spent the last three posts exploring how to implement our own QuickCheck, the goal of the next two posts will be to play with it, to test and discover properties on our code and have fun as well.">



<meta property="og:type" content="article">
<meta property="og:locale" content="en_US">
<meta property="og:site_name" content="Double Ended Queue">
<meta property="og:title" content="Experimenting with QuickCheck on a DSL">
<meta property="og:url" content="/blog/2017/02/14/quick-check-experiments.html">


  <meta property="og:description" content="After having spent the last three posts exploring how to implement our own QuickCheck, the goal of the next two posts will be to play with it, to test and discover properties on our code and have fun as well.">





  <meta name="twitter:site" content="@quduval">
  <meta name="twitter:title" content="Experimenting with QuickCheck on a DSL">
  <meta name="twitter:description" content="After having spent the last three posts exploring how to implement our own QuickCheck, the goal of the next two posts will be to play with it, to test and discover properties on our code and have fun as well.">
  <meta name="twitter:url" content="/blog/2017/02/14/quick-check-experiments.html">

  
    <meta name="twitter:card" content="summary">
    
  

  



  <meta property="article:published_time" content="2017-02-14T00:00:00+00:00">






<link rel="canonical" href="/blog/2017/02/14/quick-check-experiments.html">




<script type="application/ld+json">
  {
    "@context": "https://schema.org",
    
      "@type": "Person",
      "name": null,
      "url": "/"
    
  }
</script>







<!-- end _includes/seo.html -->



  <link href="/feed.xml" type="application/atom+xml" rel="alternate" title="Double Ended Queue Feed">


<!-- https://t.co/dKP3o1e -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">
<!--<link rel="stylesheet" href="/assets/css/overrides.css">-->
<link rel="preload" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5/css/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
<noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5/css/all.min.css"></noscript>

<!-- highlight.js support -->
<!--<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.8/styles/idea.min.css"/>-->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.8/styles/github.min.css"/>
<!--<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.8/styles/default.min.css">-->
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.8/highlight.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.8/languages/clojure.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.8/languages/cpp.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.8/languages/elixir.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.8/languages/haskell.min.js"></script>
<!--<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.8/languages/idris.min.js"></script>-->
<script>hljs.initHighlightingOnLoad();</script>
<!-- end highlight.js support -->

<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jpswalsh/academicons@1/css/academicons.min.css">




    <!-- start custom head snippets -->

<!-- insert favicons. use https://realfavicongenerator.net/ -->

<!-- end custom head snippets -->

  </head>

  <body class="layout--post">
    <nav class="skip-links">
  <ul>
    <li><a href="#site-nav" class="screen-reader-shortcut">Skip to primary navigation</a></li>
    <li><a href="#main" class="screen-reader-shortcut">Skip to content</a></li>
    <li><a href="#footer" class="screen-reader-shortcut">Skip to footer</a></li>
  </ul>
</nav>

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->

    
        

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
        <a class="site-title" href="/blog">
          Double Ended Queue
          <span class="site-subtitle">Functions In, Fictions Out</span>
        </a>
        <ul class="visible-links"><li class="masthead__menu-item">
              <a href="/">About</a>
            </li><li class="masthead__menu-item">
              <a href="/archives/">Archives</a>
            </li><li class="masthead__menu-item">
              <a href="/categories/">Categories</a>
            </li></ul>
        
        <button class="search__toggle" type="button">
          <span class="visually-hidden">Toggle search</span>
          <i class="fas fa-search"></i>
        </button>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">Toggle menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>
    

    <div class="initial-content">
      



<div id="main" role="main">
  
  <div class="sidebar sticky">
  
  
    
      
      
      
      
    
      
      
      
      
    
      
      
      
      
    
      
      
      
      
    
    
    
      <!--Future idea to search on the side bar-->
<!--
<button class="search__toggle" type="button">
    <span class="visually-hidden">Toggle search</span>
    <i class="fas fa-search"></i>
</button>
-->

<nav class="nav__list">
    <ul class="nav__items">
        <li>
            <span class="nav__sub-title">Recent posts</span>
            <ul>
                
                    <li class="sidebar__item"><a href="/blog/2022/09/05/statistical-gender-bias.html">Statistical gender bias</a></li>
                
                    <li class="sidebar__item"><a href="/blog/2022/06/19/perplexity.html">Understanding perplexity and its relation to cross-entropy and compression</a></li>
                
                    <li class="sidebar__item"><a href="/blog/2022/06/16/lm-joint-probability.html">Auto-regressive language models don't necessarily sample the most probable sentences</a></li>
                
                    <li class="sidebar__item"><a href="/blog/2022/05/24/cycling-drag-force.html">How wind affects your speed on a bike</a></li>
                
            </ul>
        </li>
    </ul>
</nav>
    
    
      <nav class="nav__list">
    <ul class="nav__items">
        <li>
            <span class="nav__sub-title">Categories</span>
            <ul>
                
                    
                    <li class="sidebar__item"><a href="/categories/#functional-programming">functional-programming</a></li>
                
                    
                    <li class="sidebar__item"><a href="/categories/#modern-cpp">modern-cpp</a></li>
                
                    
                    <li class="sidebar__item"><a href="/categories/#software-design">software-design</a></li>
                
                    
                    <li class="sidebar__item"><a href="/categories/#system-design">system-design</a></li>
                
                    
                    <li class="sidebar__item"><a href="/categories/#random-rambling">random-rambling</a></li>
                
                    
                    <li class="sidebar__item"><a href="/categories/#machine-learning">machine-learning</a></li>
                
            </ul>
        </li>
    </ul>
</nav>
    
    
      <nav class="nav__list">
    <ul class="nav__items">
        <li>
            <span class="nav__sub-title">Contact info</span>
            <ul class="author__urls social-icons">
                <li><a href="/" rel="nofollow noopener noreferrer"><i class="fas fa-fw fa-link" aria-hidden="true"></i><span class="label">Website</span></a></li>
                <li><a href="https://github.com/QuentinDuval" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-github" aria-hidden="true"></i><span class="label">GitHub</span></a></li>
                <li><a href="https://scholar.google.com/citations?user=XTaVGqYAAAAJ" rel="nofollow noopener noreferrer"><i class="ai ai-google-scholar-square" aria-hidden="true"></i><span class="label">Google Scholar</span></a></li>
                <li><a href="https://twitter.com/quduval" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-twitter-square" aria-hidden="true"></i><span class="label">Twitter</span></a></li>
                <li><a href="https://www.linkedin.com/in/quentin-duval-53ba6576" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-linkedin" aria-hidden="true"></i><span class="label">LinkedIn</span></a></li>
            </ul>
        </li>
    </ul>
</nav>
    
    
  
  </div>


  <article class="page" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="Experimenting with QuickCheck on a DSL">
    <meta itemprop="description" content="After having spent the last three posts exploring how to implement our own QuickCheck, the goal of the next two posts will be to play with it, to test and discover properties on our code and have fun as well.">
    <meta itemprop="datePublished" content="2017-02-14T00:00:00+00:00">
    

    <div class="page__inner-wrap">
      
        <header>
          <h1 id="page-title" class="page__title" itemprop="headline">Experimenting with QuickCheck on a DSL
</h1>
          

  <p class="page__meta">
    
      
      <span class="page__meta-date">
        <i class="far fa-calendar-alt" aria-hidden="true"></i>
        
        <time datetime="2017-02-14T00:00:00+00:00">February 14, 2017</time>
      </span>
    

    

    <!--
    <span class="page__meta-sep"></span>
    <span>Quentin Duval</span>
    -->

    
  </p>



    




<span id="share-buttons-light-prompt" style="color: silver;">Share on: </span>
<div id="share-buttons-light">
    <div class="twitter"  title="Share this on Twitter"     onclick="window.open('https://twitter.com/intent/tweet?url=%2Fblog%2F2017%2F02%2F14%2Fquick-check-experiments.html&text=Experimenting+with+QuickCheck+on+a+DSL&via=','popup','width=600,height=600'); return false;">
        <!--<svg viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg"><path d="M1684 408q-67 98-162 167 1 14 1 42 0 130-38 259.5t-115.5 248.5-184.5 210.5-258 146-323 54.5q-271 0-496-145 35 4 78 4 225 0 401-138-105-2-188-64.5t-114-159.5q33 5 61 5 43 0 85-11-112-23-185.5-111.5t-73.5-205.5v-4q68 38 146 41-66-44-105-115t-39-154q0-88 44-163 121 149 294.5 238.5t371.5 99.5q-8-38-8-74 0-134 94.5-228.5t228.5-94.5q140 0 236 102 109-21 205-78-37 115-142 178 93-10 186-50z"/></svg>-->
        <span class="fab fa-fw fa-twitter share-light share-light-twitter"></span>
    </div>
    <div class="facebook" title="Share this on Facebook"    onclick="window.open('http://www.facebook.com/share.php?u=%2Fblog%2F2017%2F02%2F14%2Fquick-check-experiments.html','popup','width=600,height=600'); return false;">
        <!--<svg viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg"><path d="M1343 12v264h-157q-86 0-116 36t-30 108v189h293l-39 296h-254v759h-306v-759h-255v-296h255v-218q0-186 104-288.5t277-102.5q147 0 228 12z"/></svg>-->
        <span class="fab fa-fw fa-facebook share-light share-light-facebook"></span>
    </div>
    <div class="linkedin" title="Share this on Linkedin"    onclick="window.open('https://www.linkedin.com/sharing/share-offsite/?url=%2Fblog%2F2017%2F02%2F14%2Fquick-check-experiments.html','popup','width=600,height=600'); return false;">
        <!--<svg viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg"><path d="M477 625v991h-330v-991h330zm21-306q1 73-50.5 122t-135.5 49h-2q-82 0-132-49t-50-122q0-74 51.5-122.5t134.5-48.5 133 48.5 51 122.5zm1166 729v568h-329v-530q0-105-40.5-164.5t-126.5-59.5q-63 0-105.5 34.5t-63.5 85.5q-11 30-11 81v553h-329q2-399 2-647t-1-296l-1-48h329v144h-2q20-32 41-56t56.5-52 87-43.5 114.5-15.5q171 0 275 113.5t104 332.5z"/></svg>-->
        <span class="fab fa-fw fa-linkedin share-light share-light-linkedin"></span>
    </div>
    <a class="reddit" title="Share this on Reddit" href="http://www.reddit.com/submit?url=/blog/2017/02/14/quick-check-experiments.html&title=Experimenting with QuickCheck on a DSL"
        onclick="gtag('event', 'Reddit', {'event_category':'Post Shared','event_label':'Reddit'}); window.open(this.href, 'pop-up', 'left=20,top=20,width=900,height=500,toolbar=1,resizable=0'); return false;">
        <span class="fab fa-fw fa-reddit share-light share-light-reddit"></span>
    </a>

    <a title="Share this on Hacker News"
        href="http://news.ycombinator.com/submitlink?u=/blog/2017/02/14/quick-check-experiments.html&t=Experimenting with QuickCheck on a DSL">
        <span class="fab fa-fw fa-hacker-news share-light share-light-hacker-news"></span>
    </a>
</div>


        </header>
      

      <section class="page__content" itemprop="text">
        
          <aside class="sidebar__right ">
            <nav class="toc">
              <header><h4 class="nav__title"><i class="fas fa-file-alt"></i> Table of content</h4></header>
              <ul class="toc__menu"><li><a href="#our-arithmetic-dsl">Our arithmetic DSL</a></li><li><a href="#generator-of-arithmetic-expressions">Generator of arithmetic expressions</a><ul><li><a href="#the-wrong-way">The wrong way</a></li><li><a href="#a-better-way">A better way</a></li><li><a href="#environment-generators">Environment generators</a></li></ul></li><li><a href="#verifying-and-discovering-properties">Verifying and discovering properties</a><ul><li><a href="#identifying-good-properties-to-check">Identifying good properties to check</a></li><li><a href="#optimize-should-not-change-the-value-of-expressions">Optimize should not change the value of expressions</a></li><li><a href="#partial-evaluation-of-constant-expressions-should-yield-a-number">Partial evaluation of constant expressions should yield a number</a></li><li><a href="#dependencies-should-return-the-variables-needed-for-evaluation">Dependencies should return the variables needed for evaluation</a></li><li><a href="#optimize-does-not-necessarily-preserve-the-dependencies">Optimize does not necessarily preserve the dependencies</a></li></ul></li><li><a href="#conclusion-and-whats-next">Conclusion and what’s next?</a></li></ul>

            </nav>
          </aside>
        
        <p>After having spent the last three posts exploring how to implement our own QuickCheck, the goal of the next two posts will be to play with it, to test and discover properties on our code and have fun as well.</p>

<p>The target of these experiments will be the Arithmetic DSL we built several posts back in January:</p>

<ul>
  <li><a href="/blog/2017/01/17/catamorph-dsl-intro.html">Catamorph you DSL: Introduction</a></li>
  <li><a href="/blog/2017/01/20/catamorph-dsl-deep-dive.html">Catamorph you DSL: Deep Dive</a></li>
</ul>

<p>After a quick refresher on our Arithmetic DSL and what it is made of, we will use QuickCheck to conduct some experiments on it.</p>

<p>Today’s post will focus on creating the appropriate arithmetic expression generator and put them into use to unit test our code. The next post will deal with the more exotic (and less serious) usage we can make of QuickCheck.</p>

<h2 id="our-arithmetic-dsl">Our arithmetic DSL</h2>

<p>Our Arithmetic DSL is made of 4 primitives: integer constants, variables, addition and multiplication operations. In addition to these types, we introduced the notion of environment, a mean to retrieve an integer value from a variable identifier.</p>

<p>The following code snippet depicts all the types involved:</p>

<pre><code class="language-hs">type Id = String    -- Variable identifier
type Env =          -- Environment of evaluation
  Map Id Int

data OpType         -- Types of operations
  = Add             -- * Addition
  | Mul             -- * Multiplication
  deriving (Show, Eq, Ord)

data ExprR r        -- Open recursive expression type
  = Cst Int         -- * Constant
  | Var Id          -- * Variable
  | Op OpType [r]   -- * Operation
  deriving (Show, Eq, Ord)

-- The type of arithmetic DSL (fixed point of ExprR)
type Expr = Fix ExprR
</code></pre>

<p>Our arithmetic DSL comes with a five different interpreters. We listed them with their description below:</p>

<ul>
  <li><code>prn</code>: pretty prints an Arithmetic expression</li>
  <li><code>eval</code>: computes the value of an expression, given an Env</li>
  <li><code>optimize</code>: optimizes an expression by using known constants</li>
  <li><code>partial</code>: partially computes an expression, given an Env</li>
  <li><code>dependencies</code>: retrieve all variables names from an expression</li>
</ul>

<p>The following short REPL interaction illustrate each of these interpreters:</p>

<pre><code class="language-hs">let e = add [ cst(1)
            , cst(2)
            , mul [cst(0), var("x"), var("y")]
            , mul [cst(1), var("y"), cst(2)]
            , add [cst(0), var("x") ]
            ]             

-- Pretty printing an expression
prn e
&gt; "(+ 1 2 (* 0 x y) (* 1 y 2) (+ 0 x))"

-- Optimization of an expression
prn (optimize e)
&gt; "(+ 3 (* 2 y) x)"

-- Partial evaluation of an expression
prn $ partial (Map.fromList [("y", 0)]) e
&gt; "(+ 3 x)"

-- Getting the list of variable names in an expression
dependencies e
&gt; fromList ["x","y"]

-- Full evaluation of an expression
eval (Map.fromList [("x", 1), ("y", 0)]) e
&gt; 4
</code></pre>

<p>We will stop there for the refresher. If you are curious and want to know how each of these interpreters is implemented, you are welcome to read the series on catamorphism linked in the introduction.</p>

<p>We will now dive into QuickCheck and play with it on our DSL.</p>

<h2 id="generator-of-arithmetic-expressions">Generator of arithmetic expressions</h2>

<p>To play with QuickCheck on our DSL, our first task will be to implement the required generators of arithmetic expressions.</p>

<h3 id="the-wrong-way">The wrong way</h3>

<p>The initial temptation is to create a new <code>Arbitrary</code> instance for our <code>Expression</code> and stick all the code inside it. We will resist this temptation.</p>

<p>Indeed, and except for very few rare cases, we will likely need specialized generators in order to test different properties on our code. The arguments of a function often have distinct equivalence classes.</p>

<p>For instance, our arithmetic DSL makes emerge at least one very interesting class of expression: constant expressions, which are the expression that do not contain any variables.</p>

<p>Each equivalence classes will likely need to a specific generator. If we move all the implementation into the arbitrary function, we loose a lot of flexibility by having fused everything together. <strong><code>Arbitrary</code> is better used to designate a default generator for a type.</strong></p>

<h3 id="a-better-way">A better way</h3>

<p>We will define functions returning <code>Gen Expr</code> generators. Using standard function will allow us to mix and match them to get appropriate generators for our equivalence classes. We can then optionally select one of these generators as our default generator by instantiating <code>Arbitrary Expr</code>.</p>

<p>An interesting rule of thumb when dealing with Algebraic Data Types is to <strong>create one generator by constructor of our type</strong>. This is by no mean a rule, but it happens to give good results in general.</p>

<p>Let us start with constants and variables:</p>

<ul>
  <li>Our constant generator <code>genCst</code> use the standard integer generator</li>
  <li>Our variable generator <code>genVar</code> will be letters from “a” to “z”</li>
</ul>

<pre><code class="language-hs">genCst :: Gen Expr
genCst = fmap cst arbitrary

varNames :: [String]
varNames = [[v] | v &lt;- ['a'..'z']]

genVar :: Gen Expr
genVar = fmap var (elements varNames)
</code></pre>

<p>From these, we can define another useful generator that creates expressions made of only variable or constants with equal probability. We call these simple terms (as opposed to operations which are compound terms):</p>

<pre><code class="language-hs">genSimpleTerm :: Gen Expr
genSimpleTerm = oneof [genVar, genCst]
</code></pre>

<p>Our generator of operation will take as parameter a generator for simple terms as well as a size n. The bigger the n, the more complex the generated expression:</p>

<ul>
  <li>With a probability 1/n, we generate a simple term</li>
  <li>Otherwise, we create an operation with m&lt;=n sub-expressions</li>
  <li>We recursively generate sub-expressions for size n/m</li>
</ul>

<pre><code class="language-hs">opsGen :: Gen Expr -&gt; Int -&gt; Gen Expr
opsGen simpleTermGen = go where
  go n = do
    m &lt;- choose (0, n)
    if m == 0
      then simpleTermGen
      else elements [add, mul] &lt;*&gt; replicateM m (go (div n (m + 1)))
</code></pre>

<p>Since our operation generator can be parameterized by a simple term generator, we have the flexibility to defined two specialized generators:</p>

<ul>
  <li><code>genExpr</code>: a generator of expression that may contain variables</li>
  <li><code>genCstExpr</code>: a generator of expression that contains no variable</li>
</ul>

<pre><code class="language-hs">genExpr :: Int -&gt; Gen Expr
genExpr = opsGen genSimpleTerm

genCstExpr :: Int -&gt; Gen Expr
genCstExpr = opsGen genCst
</code></pre>

<p>These generators will be quite handy in the following.</p>

<h3 id="environment-generators">Environment generators</h3>

<p>As well as generating arbitrary arithmetic expressions, we will need to generate environment of evaluation to test our eval and partial interpreters.</p>

<p>Again, we will likely need different generators, so we define the following functions instead of rushing for <code>Arbitrary</code> (*):</p>

<ul>
  <li><code>makeEnvWith</code> allows us to create an environment holding random values for some predefined variable identifiers</li>
  <li><code>genTotalEnv</code> creates an environment associating a value to all possible variable identifiers used in our tests</li>
</ul>

<pre><code class="language-hs">makeEnvWith :: Set.Set String -&gt; Gen Env
makeEnvWith deps = do
  let n = Set.size deps
  values &lt;- replicateM n arbitrary
  return $ Map.fromList (zip (Set.toList deps) values)

genTotalEnv :: Gen Env
genTotalEnv = makeEnvWith (Set.fromList varNames)
</code></pre>

<p><em>(*) QuickCheck can be quite helpful at showing us design defects in our code. We cannot create a new Arbitrary instance for our Env type because it is a type synonym of a Map, which already has one such instance defined. QuickCheck points to us the need for stronger type.</em></p>

<h2 id="verifying-and-discovering-properties">Verifying and discovering properties</h2>

<p>Now that we have quite a few generators of expressions available, we can use them in combination with QuickCheck to verify some interesting properties on our Arithmetic expressions.</p>

<h3 id="identifying-good-properties-to-check">Identifying good properties to check</h3>

<p>Before we start, we should remind ourselves that QuickCheck is no replacement for all our example based tests. QuickCheck is really great at ensuring that some invariants hold, but will not handle very specific test cases.</p>

<p>For example, checking that our eval function does output the right number cannot be easily done, except by replicating most of the logic of eval inside the test. This would somehow defeat the purpose of our test.</p>

<p>What we can do however is to check relations between our different interpreters. There are quite a few that should pop in our head. We selected some representative examples below.</p>

<h3 id="optimize-should-not-change-the-value-of-expressions">Optimize should not change the value of expressions</h3>

<p>This property points at an interesting relation between the optimize function and the eval function.</p>

<p>Evaluating an expression should yield the same value as evaluating the optimised expression in the same environment. This should hold for every environment that contains the variables appearing in the non-optimised expression (*).</p>

<pre><code class="language-hs">prop_optimize_eval :: Expr -&gt; Property
prop_optimize_eval e =
  forAll genTotalEnv $ \env -&gt;
    eval env e == eval env (optimize e)

quickCheck prop_optimize_eval
&gt; +++ OK, passed 100 tests.
</code></pre>

<p><em>(*) The “non-optimized” qualifier is necessary. Our last test will show us some interesting twists which make this distinction important.</em></p>

<h3 id="partial-evaluation-of-constant-expressions-should-yield-a-number">Partial evaluation of constant expressions should yield a number</h3>

<p>In the post describing our Arithmetic DSL, we pointed out that eval could be implemented in terms of partial evaluation. If the result of a partial evaluation is a constant term, we just had to unwrap it and get the value of the expression.</p>

<p>This argument was based on the assumption that the partial evaluation is able to fully optimize a constant expression into a single constant term. Since partial is based on optimize, this property should also hold for the later.</p>

<pre><code class="language-hs">prop_optimize_constant :: Property
prop_optimize_constant =
  forAll (sized genCstExpr) (isCst . optimize)

prop_partial_constant :: Property
prop_partial_constant =
  forAll (sized genCstExpr) (isCst . partial Map.empty)
</code></pre>

<p>The <code>sized</code> function is a quite helpful QuickCheck helper that allows us to inject the size of the input into our generator <code>genCstExpr</code>.</p>

<h3 id="dependencies-should-return-the-variables-needed-for-evaluation">Dependencies should return the variables needed for evaluation</h3>

<p>This property points out at an interesting relation between our evaluation functions and the dependencies. If each variable identifier returned by dependencies appears in the environment, partial should be able to fully reduce an expression to a constant term.</p>

<pre><code class="language-hs">prop_dependencies_allow_eval :: Property
prop_dependencies_allow_eval =
  forAll (sized genExpr) $ \e -&gt;
    forAll (makeEnvWith (dependencies e)) $ \env -&gt;
      isCst (partial env e)
</code></pre>

<p>We may have the feeling the converse should also hold: if a single variable from an dependencies does not appear in the environment, partial should not be able to fully evaluate an expression.</p>

<pre><code class="language-hs">makePartialEnv :: Set.Set Id -&gt; Gen Env
makePartialEnv deps = do
  v &lt;- elements (Set.toList deps)
  makeEnvWith (Set.delete v deps)

prop_missing_dependencies_forbid_eval :: Property
prop_missing_dependencies_forbid_eval =
  forAll (sized genExpr) $ \e -&gt;
    let deps = dependencies e
    in Set.size deps &gt; 0 ==&gt;
        forAll (makePartialEnv deps) $ \env -&gt;
          not (isCst (partial env e))
</code></pre>

<p>But actually, our property fails:</p>

<pre><code class="language-hs">quickCheck prop_missing_dependencies_forbid_eval
&gt; *** Failed! Falsifiable (after 4 tests): 
&gt; (* g x)
&gt; fromList [("x",0)]

quickCheck prop_missing_dependencies_forbid_eval
&gt; *** Failed! Falsifiable (after 4 tests): 
&gt; (* 0 b q)
&gt; fromList [("b",2)]
</code></pre>

<p>And indeed, <code>(* g x)</code> does not necessarily require all variables to be bound to get a value out the expression. If either <code>g</code> or <code>x</code> is equal to zero, the expression is trivially equal to zero. The second counter example featuring <code>(* 0 b q)</code> is even more telling.</p>

<p>We discovered that our partial function was in fact able to evaluate expressions that do not have all their variable bound in the environment. QuickCheck discovered this knowledge for us, with only 4 tests.</p>

<p>Using QuickCheck, we can quickly encounter many similar experiences. <strong>QuickCheck is quite impressive at proving us wrong</strong>. Doing so, it participates rather effectively at increasing the knowledge on our own code.</p>

<h3 id="optimize-does-not-necessarily-preserve-the-dependencies">Optimize does not necessarily preserve the dependencies</h3>

<p>From the previous experiment, we can deduce that our optimize function does not systematically preserves the dependencies of an expression.</p>

<p><strong>We can express the negation</strong> (that it should keep the dependencies of an expression unchanged), and indicate to QuickCheck we expected the property to fail:</p>

<pre><code class="language-hs">prop_optimize_preserves_dependencies :: Property
prop_optimize_preserves_dependencies =
  forAll (sized genExpr) $ \e -&gt;
    dependencies e == dependencies (optimize e)

quickCheck (expectFailure prop_optimize_preserves_dependencies)
&gt; +++ OK, failed as expected. Falsifiable (after 8 tests): 
&gt; (* g r e m (* 0))
</code></pre>

<p>Going back to our first test, we now understand why the distinction “non-optimised” in the property definition was quite an important one.</p>

<h2 id="conclusion-and-whats-next">Conclusion and what’s next?</h2>

<p>We took as example our Arithmetic DSL we build in earlier posts, and used QuickCheck to build some generators and check some properties on it.</p>

<p>Through these experiments, we discussed strategies to build generators and discovered several interesting use cases of QuickCheck:</p>

<ul>
  <li>Its ability to reveal some design defects</li>
  <li>Its ability to test high level relations between functions</li>
  <li>Its ability to increase our knowledge by proving us wrong</li>
  <li>Its ability to check that some property can be falsified</li>
</ul>

<p>Next post will be dedicated to more “exotic” and maybe be less “serious” use cases for QuickCheck.</p>


        
      </section>

      <footer class="page__meta">
        
        


        

  <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> Updated:</strong> <time datetime="2017-02-14T00:00:00+00:00">February 14, 2017</time></p>


      </footer>

      <section class="page__share">
    
  
    <a href="https://twitter.com/intent/tweet?via=quduval&text=Experimenting+with+QuickCheck+on+a+DSL%20%2Fblog%2F2017%2F02%2F14%2Fquick-check-experiments.html" class="btn btn--twitter" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Twitter"><i class="fab fa-fw fa-twitter" aria-hidden="true"></i><span> Twitter</span></a>
  
    <a href="https://www.facebook.com/sharer/sharer.php?u=%2Fblog%2F2017%2F02%2F14%2Fquick-check-experiments.html" class="btn btn--facebook" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Facebook"><i class="fab fa-fw fa-facebook" aria-hidden="true"></i><span> Facebook</span></a>
  
    <!--
    <a href="https://www.linkedin.com/shareArticle?mini=true&url=%2Fblog%2F2017%2F02%2F14%2Fquick-check-experiments.html" class="btn btn--linkedin" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on LinkedIn"><i class="fab fa-fw fa-linkedin" aria-hidden="true"></i><span> LinkedIn</span></a>
    -->
    
    <a href="https://www.reddit.com/submit?url=%2Fblog%2F2017%2F02%2F14%2Fquick-check-experiments.html&title=Experimenting+with+QuickCheck+on+a+DSL" class="btn" style="background-color: #ff4500; color: white" title=" Reddit"><i class="fab fa-fw fa-reddit" aria-hidden="true"></i><span> Reddit</span></a>

    <a href="http://news.ycombinator.com/submitlink?u=%2Fblog%2F2017%2F02%2F14%2Fquick-check-experiments.html&t=Experimenting with QuickCheck on a DSL" class="btn" style="background-color: #ff6600; color: white"  title=" Hackernews"><i class="fab fa-fw fa-hacker-news" aria-hidden="true"></i><span> Hacker News</span></a>

</section>

      
<div class="post_navi_hr">&nbsp;</div>
<hr class="post_navi_hr">
<div class="post_navi"><a class="post_navi-item nav_prev" href="/blog/2017/02/10/code-quick-check-3.html" title="Code your own Quick Check (Shrink)">
    <div class="post_navi-arrow">&lt;</div><div class="post_navi-label">Previous Post</div><div><span class="post_navi-title">Code your own Quick Check (Shrink)</span></div>
  </a><a class="post_navi-item nav_next" href="/blog/2017/02/17/quick-check-is-fun.html" title="Quickcheck is fun, deal with it">
    <div class="post_navi-arrow">&gt;</div><div class="post_navi-label">Next Post</div><div><span class="post_navi-title">Quickcheck is fun, deal with it</span></div>
  </a></div>

    </div>

    
      <div class="page__comments">
  
  
      <h4 class="page__comments-title">Comments</h4>
      <section id="giscus-comments"></section>
    
</div>

    
  </article>

  
  
    <div class="page__related">
      <h4 class="page__related-title">You May Also Enjoy</h4>
      <div class="grid__wrapper">
        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/blog/2022/09/05/statistical-gender-bias.html" rel="permalink">Statistical gender bias
</a>
      
    </h2>
    
        <p class="archive__item-excerpt" itemprop="description">I recently stumbled on a debate where J. Peterson argues that the gender pay gap is mostly not due to gender bias. Let’s see what’s wrong with his argument.
</p>
    
    
<p class="page__meta">

  
    
    <span class="page__meta-date">
      <i class="far fa-calendar-alt" aria-hidden="true"></i>
      
      <time datetime="2022-09-05T00:00:00+00:00">September 5, 2022</time>
      
        &bull; random-rambling
      
    </span>
  

  

  
</p>

  </article>
</div>
        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/blog/2022/06/19/perplexity.html" rel="permalink">Understanding perplexity and its relation to cross-entropy and compression
</a>
      
    </h2>
    
        <p class="archive__item-excerpt" itemprop="description">Modern conditional and unconditional language models often report their perplexity as validation metrics. Let’s see what it means.
</p>
    
    
<p class="page__meta">

  
    
    <span class="page__meta-date">
      <i class="far fa-calendar-alt" aria-hidden="true"></i>
      
      <time datetime="2022-06-19T00:00:00+00:00">June 19, 2022</time>
      
        &bull; machine-learning
      
    </span>
  

  

  
</p>

  </article>
</div>
        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/blog/2022/06/16/lm-joint-probability.html" rel="permalink">Auto-regressive language models don’t necessarily sample the most probable sentences
</a>
      
    </h2>
    
        <p class="archive__item-excerpt" itemprop="description">Have you even tried to sample greedily from a language model. It’s not a good idea. Let’s discuss why.
</p>
    
    
<p class="page__meta">

  
    
    <span class="page__meta-date">
      <i class="far fa-calendar-alt" aria-hidden="true"></i>
      
      <time datetime="2022-06-16T00:00:00+00:00">June 16, 2022</time>
      
        &bull; machine-learning
      
    </span>
  

  

  
</p>

  </article>
</div>
        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/blog/2022/05/24/cycling-drag-force.html" rel="permalink">How wind affects your speed on a bike
</a>
      
    </h2>
    
        <p class="archive__item-excerpt" itemprop="description">Let’s look at how the wind affect your speed on a bike, the diminishing impact of power, and why you feel the drag suddenly passed a certain speed.
</p>
    
    
<p class="page__meta">

  
    
    <span class="page__meta-date">
      <i class="far fa-calendar-alt" aria-hidden="true"></i>
      
      <time datetime="2022-05-24T00:00:00+00:00">May 24, 2022</time>
      
        &bull; random-rambling
      
    </span>
  

  

  
</p>

  </article>
</div>
        
      </div>
    </div>
  
  
</div>

    </div>

    
      <div class="search-content">
        <div class="search-content__inner-wrap"><form class="search-content__form" onkeydown="return event.key != 'Enter';">
    <label class="sr-only" for="search">
      Enter your search term...
    </label>
    <input type="search" id="search" class="search-input" tabindex="-1" placeholder="Enter your search term..." />
  </form>
  <div id="results" class="results"></div></div>

      </div>
    

    <div id="footer" class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        <div class="page__footer-follow">
  <ul class="social-icons">
    

    
      
        
          <li><a href="https://github.com/QuentinDuval" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-github" aria-hidden="true"></i> GitHub</a></li>
        
      
        
          <li><a href="https://twitter.com/quduval" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-twitter-square" aria-hidden="true"></i> Twitter</a></li>
        
      
        
          <li><a href="https://www.linkedin.com/in/quentin-duval-53ba6576/" rel="nofollow noopener noreferrer"><i class="fab fa-linkedin" aria-hidden="true"></i> LinkedIn</a></li>
        
      
    

    
      <li><a href="/feed.xml"><i class="fas fa-fw fa-rss-square" aria-hidden="true"></i> Feed</a></li>
    
  </ul>
</div>

<div class="page__footer-copyright">&copy; 2022 Double Ended Queue. Powered by <a href="https://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://mademistakes.com/work/minimal-mistakes-jekyll-theme/" rel="nofollow">Minimal Mistakes</a>.</div>

      </footer>
    </div>

    
  <script src="/assets/js/main.min.js"></script>




<script src="/assets/js/lunr/lunr.min.js"></script>
<script src="/assets/js/lunr/lunr-store.js"></script>
<script src="/assets/js/lunr/lunr-en.js"></script>




  <script>
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'G-RRHHYN266B']);
  
    _gaq.push(['_gat._anonymizeIp']);
  
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>






    <script>
  'use strict';

  (function () {
    var commentContainer = document.querySelector('#giscus-comments');

    if (!commentContainer) {
      return;
    }

    var script = document.createElement('script');
    script.setAttribute('src', 'https://giscus.app/client.js');
    script.setAttribute('data-repo', 'quentinduval/quentinduval.github.io');
    script.setAttribute('data-repo-id', 'MDEwOlJlcG9zaXRvcnk3MzUyMDE3Nw==');
    script.setAttribute('data-category', 'General');
    script.setAttribute('data-category-id', 'DIC_kwDOBGHUMc4CBKf3');
    script.setAttribute('data-mapping', 'url');
    script.setAttribute('data-reactions-enabled', '1');
    script.setAttribute('data-theme', 'light');
    script.setAttribute('crossorigin', 'anonymous');

    commentContainer.appendChild(script);
  })();
</script>
  





  </body>
</html>
