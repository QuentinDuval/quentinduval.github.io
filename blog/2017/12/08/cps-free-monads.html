<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.24.0 by Michael Rose
  Copyright 2013-2020 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>Continuation passing style Free Monads and direct style Free Monads - Double Ended Queue</title>
<meta name="description" content="Generalized Algebraic Data Types gives us the power to develop type-safe Free Monads, without having to rely on continuation passing style.">



<meta property="og:type" content="article">
<meta property="og:locale" content="en_US">
<meta property="og:site_name" content="Double Ended Queue">
<meta property="og:title" content="Continuation passing style Free Monads and direct style Free Monads">
<meta property="og:url" content="/blog/2017/12/08/cps-free-monads.html">


  <meta property="og:description" content="Generalized Algebraic Data Types gives us the power to develop type-safe Free Monads, without having to rely on continuation passing style.">





  <meta name="twitter:site" content="@quduval">
  <meta name="twitter:title" content="Continuation passing style Free Monads and direct style Free Monads">
  <meta name="twitter:description" content="Generalized Algebraic Data Types gives us the power to develop type-safe Free Monads, without having to rely on continuation passing style.">
  <meta name="twitter:url" content="/blog/2017/12/08/cps-free-monads.html">

  
    <meta name="twitter:card" content="summary">
    
  

  



  <meta property="article:published_time" content="2017-12-08T00:00:00+00:00">






<link rel="canonical" href="/blog/2017/12/08/cps-free-monads.html">




<script type="application/ld+json">
  {
    "@context": "https://schema.org",
    
      "@type": "Person",
      "name": null,
      "url": "/"
    
  }
</script>







<!-- end _includes/seo.html -->



  <link href="/feed.xml" type="application/atom+xml" rel="alternate" title="Double Ended Queue Feed">


<!-- https://t.co/dKP3o1e -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">
<!--<link rel="stylesheet" href="/assets/css/overrides.css">-->
<link rel="preload" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5/css/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
<noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5/css/all.min.css"></noscript>

<!-- highlight.js support -->
<!--<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.8/styles/idea.min.css"/>-->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.8/styles/github.min.css"/>
<!--<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.8/styles/default.min.css">-->
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.8/highlight.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.8/languages/clojure.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.8/languages/cpp.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.8/languages/elixir.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.8/languages/haskell.min.js"></script>
<!--<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.8/languages/idris.min.js"></script>-->
<script>hljs.initHighlightingOnLoad();</script>
<!-- end highlight.js support -->

<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jpswalsh/academicons@1/css/academicons.min.css">


  <script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        TeX: {
          equationNumbers: {
            autoNumber: "AMS"
          }
        },
        tex2jax: {
        inlineMath: [ ['$', '$'] ],
        displayMath: [ ['$$', '$$'] ],
        processEscapes: true,
      }
    });
    MathJax.Hub.Register.MessageHook("Math Processing Error",function (message) {
          alert("Math Processing Error: "+message[1]);
        });
    MathJax.Hub.Register.MessageHook("TeX Jax - parse error",function (message) {
          alert("Math Processing Error: "+message[1]);
        });
    </script>
<script type="text/javascript" async src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-MML-AM_CHTML">
</script>



    <!-- start custom head snippets -->

<!-- insert favicons. use https://realfavicongenerator.net/ -->

<!-- end custom head snippets -->

  </head>

  <body class="layout--post">
    <nav class="skip-links">
  <ul>
    <li><a href="#site-nav" class="screen-reader-shortcut">Skip to primary navigation</a></li>
    <li><a href="#main" class="screen-reader-shortcut">Skip to content</a></li>
    <li><a href="#footer" class="screen-reader-shortcut">Skip to footer</a></li>
  </ul>
</nav>

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->

    
        

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
        <a class="site-title" href="/blog">
          Double Ended Queue
          <span class="site-subtitle">Functions In, Fictions Out</span>
        </a>
        <ul class="visible-links"><li class="masthead__menu-item">
              <a href="/">About</a>
            </li><li class="masthead__menu-item">
              <a href="/archives/">Archives</a>
            </li><li class="masthead__menu-item">
              <a href="/categories/">Categories</a>
            </li></ul>
        
        <button class="search__toggle" type="button">
          <span class="visually-hidden">Toggle search</span>
          <i class="fas fa-search"></i>
        </button>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">Toggle menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>
    

    <div class="initial-content">
      



<div id="main" role="main">
  
  <div class="sidebar sticky">
  
  
    
      
      
      
      
    
      
      
      
      
    
      
      
      
      
    
      
      
      
      
    
    
    
      <!--Future idea to search on the side bar-->
<!--
<button class="search__toggle" type="button">
    <span class="visually-hidden">Toggle search</span>
    <i class="fas fa-search"></i>
</button>
-->

<nav class="nav__list">
    <ul class="nav__items">
        <li>
            <span class="nav__sub-title">Recent posts</span>
            <ul>
                
                    <li class="sidebar__item"><a href="/blog/2022/09/05/statistical-gender-bias.html">Statistical gender bias</a></li>
                
                    <li class="sidebar__item"><a href="/blog/2022/06/19/perplexity.html">Understanding perplexity and its relation to cross-entropy and compression</a></li>
                
                    <li class="sidebar__item"><a href="/blog/2022/06/16/lm-joint-probability.html">Auto-regressive language models don't necessarily sample the most probable sentences</a></li>
                
                    <li class="sidebar__item"><a href="/blog/2022/05/24/cycling-drag-force.html">How wind affects your speed on a bike</a></li>
                
            </ul>
        </li>
    </ul>
</nav>
    
    
      <nav class="nav__list">
    <ul class="nav__items">
        <li>
            <span class="nav__sub-title">Categories</span>
            <ul>
                
                    
                    <li class="sidebar__item"><a href="/categories/#functional-programming">functional-programming</a></li>
                
                    
                    <li class="sidebar__item"><a href="/categories/#modern-cpp">modern-cpp</a></li>
                
                    
                    <li class="sidebar__item"><a href="/categories/#software-design">software-design</a></li>
                
                    
                    <li class="sidebar__item"><a href="/categories/#system-design">system-design</a></li>
                
                    
                    <li class="sidebar__item"><a href="/categories/#random-rambling">random-rambling</a></li>
                
                    
                    <li class="sidebar__item"><a href="/categories/#machine-learning">machine-learning</a></li>
                
            </ul>
        </li>
    </ul>
</nav>
    
    
      <nav class="nav__list">
    <ul class="nav__items">
        <li>
            <span class="nav__sub-title">Contact info</span>
            <ul class="author__urls social-icons">
                <li><a href="/" rel="nofollow noopener noreferrer"><i class="fas fa-fw fa-link" aria-hidden="true"></i><span class="label">Website</span></a></li>
                <li><a href="https://github.com/QuentinDuval" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-github" aria-hidden="true"></i><span class="label">GitHub</span></a></li>
                <li><a href="https://scholar.google.com/citations?user=XTaVGqYAAAAJ" rel="nofollow noopener noreferrer"><i class="ai ai-google-scholar-square" aria-hidden="true"></i><span class="label">Google Scholar</span></a></li>
                <li><a href="https://twitter.com/quduval" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-twitter-square" aria-hidden="true"></i><span class="label">Twitter</span></a></li>
                <li><a href="https://www.linkedin.com/in/quentin-duval-53ba6576" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-linkedin" aria-hidden="true"></i><span class="label">LinkedIn</span></a></li>
            </ul>
        </li>
    </ul>
</nav>
    
    
  
  </div>


  <article class="page" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="Continuation passing style Free Monads and direct style Free Monads">
    <meta itemprop="description" content="Generalized Algebraic Data Types gives us the power to develop type-safe Free Monads, without having to rely on continuation passing style.">
    <meta itemprop="datePublished" content="2017-12-08T00:00:00+00:00">
    

    <div class="page__inner-wrap">
      
        <header>
          <h1 id="page-title" class="page__title" itemprop="headline">Continuation passing style Free Monads and direct style Free Monads
</h1>
          

  <p class="page__meta">
    
      
      <span class="page__meta-date">
        <i class="far fa-calendar-alt" aria-hidden="true"></i>
        
        <time datetime="2017-12-08T00:00:00+00:00">December 8, 2017</time>
      </span>
    

    

    <!--
    <span class="page__meta-sep"></span>
    <span>Quentin Duval</span>
    -->

    
  </p>



    




<span id="share-buttons-light-prompt" style="color: silver;">Share on: </span>
<div id="share-buttons-light">
    <div class="twitter"  title="Share this on Twitter"     onclick="window.open('https://twitter.com/intent/tweet?url=%2Fblog%2F2017%2F12%2F08%2Fcps-free-monads.html&text=Continuation+passing+style+Free+Monads+and+direct+style+Free+Monads&via=','popup','width=600,height=600'); return false;">
        <!--<svg viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg"><path d="M1684 408q-67 98-162 167 1 14 1 42 0 130-38 259.5t-115.5 248.5-184.5 210.5-258 146-323 54.5q-271 0-496-145 35 4 78 4 225 0 401-138-105-2-188-64.5t-114-159.5q33 5 61 5 43 0 85-11-112-23-185.5-111.5t-73.5-205.5v-4q68 38 146 41-66-44-105-115t-39-154q0-88 44-163 121 149 294.5 238.5t371.5 99.5q-8-38-8-74 0-134 94.5-228.5t228.5-94.5q140 0 236 102 109-21 205-78-37 115-142 178 93-10 186-50z"/></svg>-->
        <span class="fab fa-fw fa-twitter share-light share-light-twitter"></span>
    </div>
    <div class="facebook" title="Share this on Facebook"    onclick="window.open('http://www.facebook.com/share.php?u=%2Fblog%2F2017%2F12%2F08%2Fcps-free-monads.html','popup','width=600,height=600'); return false;">
        <!--<svg viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg"><path d="M1343 12v264h-157q-86 0-116 36t-30 108v189h293l-39 296h-254v759h-306v-759h-255v-296h255v-218q0-186 104-288.5t277-102.5q147 0 228 12z"/></svg>-->
        <span class="fab fa-fw fa-facebook share-light share-light-facebook"></span>
    </div>
    <div class="linkedin" title="Share this on Linkedin"    onclick="window.open('https://www.linkedin.com/sharing/share-offsite/?url=%2Fblog%2F2017%2F12%2F08%2Fcps-free-monads.html','popup','width=600,height=600'); return false;">
        <!--<svg viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg"><path d="M477 625v991h-330v-991h330zm21-306q1 73-50.5 122t-135.5 49h-2q-82 0-132-49t-50-122q0-74 51.5-122.5t134.5-48.5 133 48.5 51 122.5zm1166 729v568h-329v-530q0-105-40.5-164.5t-126.5-59.5q-63 0-105.5 34.5t-63.5 85.5q-11 30-11 81v553h-329q2-399 2-647t-1-296l-1-48h329v144h-2q20-32 41-56t56.5-52 87-43.5 114.5-15.5q171 0 275 113.5t104 332.5z"/></svg>-->
        <span class="fab fa-fw fa-linkedin share-light share-light-linkedin"></span>
    </div>
    <a class="reddit" title="Share this on Reddit" href="http://www.reddit.com/submit?url=/blog/2017/12/08/cps-free-monads.html&title=Continuation passing style Free Monads and direct style Free Monads"
        onclick="gtag('event', 'Reddit', {'event_category':'Post Shared','event_label':'Reddit'}); window.open(this.href, 'pop-up', 'left=20,top=20,width=900,height=500,toolbar=1,resizable=0'); return false;">
        <span class="fab fa-fw fa-reddit share-light share-light-reddit"></span>
    </a>

    <a title="Share this on Hacker News"
        href="http://news.ycombinator.com/submitlink?u=/blog/2017/12/08/cps-free-monads.html&t=Continuation passing style Free Monads and direct style Free Monads">
        <span class="fab fa-fw fa-hacker-news share-light share-light-hacker-news"></span>
    </a>
</div>


        </header>
      

      <section class="page__content" itemprop="text">
        
          <aside class="sidebar__right ">
            <nav class="toc">
              <header><h4 class="nav__title"><i class="fas fa-file-alt"></i> Table of content</h4></header>
              <ul class="toc__menu"><li><a href="#quick-summary-of-the-last-episode">Quick summary of the last episode</a><ul><li><a href="#free-monads-in-short">Free Monads (in short)</a></li><li><a href="#free-monads-in-3-steps">Free Monads in 3 steps</a></li><li><a href="#intepreting-our-free-monad">Intepreting our Free Monad</a></li></ul></li><li><a href="#continuation-passing-style-ast">Continuation Passing Style AST</a><ul><li><a href="#what-is-continuation-passing-style">What is Continuation Passing Style?</a></li><li><a href="#abstracting-continuation-passing-style">Abstracting Continuation Passing Style</a></li><li><a href="#iospec-continuation-passing-style">IOSpec continuation passing style</a></li></ul></li><li><a href="#toward-direct-style-ast-using-gadts">Toward direct style AST using GADTs</a><ul><li><a href="#using-gadt-for-a-direct-style-ast">Using GADT for a direct style AST</a></li><li><a href="#making-it-a-monad">Making it a Monad</a></li><li><a href="#a-specification-for-the-interpreters">A specification for the interpreters</a></li><li><a href="#simpler-interpretation">Simpler interpretation</a></li><li><a href="#bind-factors-the-continuation">Bind factors the continuation</a></li></ul></li><li><a href="#the-end-of-our-journey">The end of our journey</a><ul><li><a href="#continuation-passing-style">Continuation Passing Style</a></li><li><a href="#switching-to-direct-style">Switching to Direct Style</a></li></ul></li></ul>

            </nav>
          </aside>
        
        <p><em><a href="https://en.wikibooks.org/wiki/Haskell/GADT">Generalized Algebraic Data Types</a> gives us the power to develop type-safe Free Monads, without having to rely on continuation passing style when using simple <a href="https://en.wikipedia.org/wiki/Algebraic_data_type">Algebraic Data Types</a>.</em></p>

<p>In today’s post, we will revisit the first Embedded Domain Specific Language (EDSL) example of our previous <a href="/blog/2017/11/13/free-monads-intro.html">Free Monad tutorial</a> post. We will look at its Abstract Syntax Tree (AST) again, and show its similarities to the <a href="https://en.wikipedia.org/wiki/Continuation-passing_style">continuation passing style</a> (CPS) of programming.</p>

<p>We will then explore another way we can define an AST for the same language, only this time in direct style, the opposite of continuation passing style, using <a href="https://en.wikibooks.org/wiki/Haskell/GADT">Generalized Algebraic Data Types</a>.</p>

<p>We will talk about the advantages of defining an AST in direct style, and conclude by giving a small recipe we can use to almost automatically create a Free Monad from a set of instructions we want to support in a Domain Specific Language (DSL).</p>

<h2 id="quick-summary-of-the-last-episode">Quick summary of the last episode</h2>

<p>This post is a follow up of our previous <a href="/blog/2017/11/13/free-monads-intro.html">Free Monad tutorial post</a> in which we first introduced the basics of Free Monads and interpreters, before discussing more advanced examples where Free Monads are especially interesting.</p>

<p>We will start with a summary of the last episode, just enough for our purpose here. If you read the previous post or are familiar enough with Free Monads, you should skip this section.</p>

<h3 id="free-monads-in-short">Free Monads (in short)</h3>

<p>Free Monads are special kinds of Monads which produce an Abstract Syntax Tree (AST) upon evaluation, a data structure for a recipe to execute. They do not perform side-effects directly, they only emit instructions. Nothing really happens until an interpreter reads these instructions to interact with the world.</p>

<p>As shown in our <a href="/blog/2017/11/13/free-monads-intro.html">previous post</a>, it gives us a great flexibility in terms of evaluation of the AST. We can switch back-ends, and write <strong>several interpreters</strong> to produce different effects out of the same AST (recipe).</p>

<p>We also illustrated the great power it offers us in terms of consulting, <strong>transforming</strong> or even <strong>combining</strong> recipes before evaluating them with an interpreter.</p>

<h3 id="free-monads-in-3-steps">Free Monads in 3 steps</h3>

<p>We previously showed in 3 steps how to decouple the recipe for an <code>IO</code> computation, asking the user for a password, from its execution.</p>

<pre><code class="language-haskell">password : Nat -&gt; (String -&gt; Bool) -&gt; IO Bool
password maxAttempt valid = do
  putStrLn "Password:"     — Ask the user for a password
  attempt &lt;- getLine       — Read the password entered by the user
  if valid attempt         — In case of valid password:
  — More code
</code></pre>

<p>Our first step was to identify and isolate the side-effects needed to express this computation. We identified two of them: reading a string from and writing a string to the standard output. We then created an AST containing of the instructions needed to support the side-effect we identified.</p>

<p>Here is the AST we developped for our IOSpec Domain Specific Language (DSL):</p>

<pre><code class="language-haskell">data IOSpec a
  = ReadLine (String -&gt; IOSpec a)
  | PrintLine String (IOSpec a)
  | Pure a
</code></pre>

<ul>
  <li><code>ReadLine</code> represents the instruction of reading a line. It contains a continuation which represents the set of instructions to execute after getting the string from the console.</li>
  <li><code>Writeline</code> represents the instruction of writing a line. It contains the string to print and the set of instructions to execute after the printing is done.</li>
  <li><code>Pure</code> is the marker for the end of the computation. It carries inside the result of the overall computation.</li>
</ul>

<p>The second and third steps were respectively to create some factory functions and to make our <code>IOSpec</code> AST a Monad. These two steps completed the construction of our Free Monad, making it easy to emit an <code>IOSpec</code> AST by writing imperative looking code that uses the do-notation.</p>

<h3 id="intepreting-our-free-monad">Intepreting our Free Monad</h3>

<p>For a sequence of instructions emitted by a Free Monad to be useful, we need an interpreter to translate the AST instructions into a lower level language, such as <code>IO</code>.</p>

<p>We illustrated this by developing a simple interpreter which transforms a computation expressed in the <code>IOSpec</code> Free Monad into a IO computation to execute it:</p>

<pre><code class="language-haskell">interpret : IOSpec r -&gt; IO r
interpret (Pure a) = pure a
interpret (ReadLine cont) = do
  l &lt;- getLine
  interpret (cont l)
interpret (WriteLine s next) = do
  putStrLn s
  interpret next
</code></pre>

<p>This was a short summary of the first part of our <a href="/blog/2017/11/13/free-monads-intro.html">previous post on Free Monads</a>. You can have a look at the rest of the post if you are interested in transformation on Free Monads AST.</p>

<h2 id="continuation-passing-style-ast">Continuation Passing Style AST</h2>

<p>Let us now explore in what aspects the <code>IOSpec</code> Abstract Syntax Tree we just defined resembles the continuation passing style (CPS) of programming.</p>

<h3 id="what-is-continuation-passing-style">What is Continuation Passing Style?</h3>

<p>The <a href="https://en.wikipedia.org/wiki/Continuation-passing_style">Continuation passing style</a> of programming consists in explicitly passing to each function a continuation which is a function that represents the rest of the computation to perform.</p>

<p>In direct style, a function returns its result of type a directly. It just returns the value. This is the default style in most programming languages:</p>

<pre><code class="language-haskell">parens : String -&gt; String
parens s = "(" ++ s ++ ")"

— In the REPL:
parens "Hello"
&gt; "(Hello)"
</code></pre>

<p>In continuation passing style, a function takes an additional function – named a continuation – from <code>a</code> to an arbitrary type <code>r</code> as parameter, and calls it on its result of type <code>a</code>:</p>

<pre><code class="language-haskell">parensCps : String -&gt; (String -&gt; r) -&gt; r
parensCps s cont = cont ("(" ++ s ++ ")")
</code></pre>

<p>We will not go in details over the advantages of switching to continuation passing style (which include for example turning stack recursion into heap recursion). Instead, we will look at the overall pattern, abstract it, and see how this abstraction relates to our <code>IOSpec</code> AST.</p>

<h3 id="abstracting-continuation-passing-style">Abstracting Continuation Passing Style</h3>

<p>Looking back at the definition of our parensCps continuation passing style function, we can see a pattern. The return type of the function follows the pattern <code>(a -&gt; r) -&gt; r</code>, where:</p>

<ul>
  <li><code>a</code> is the result type the function would have in direct style</li>
  <li><code>a -&gt; r</code> is the type of the continuation</li>
  <li><code>r</code> is the result type of the continuation</li>
</ul>

<p>In the case of <code>parensCps</code>, a matches the string type (the return type of <code>parens</code> written in direct style), while our continuation has the type <code>String -&gt; a</code>:</p>

<pre><code class="language-haskell">parensCps : String -&gt; (String -&gt; r) -&gt; r
parensCps s cont = cont ("(" ++ s ++ ")")
</code></pre>

<p>We can capture this pattern through the type (or type alias in our case) <code>Cont r a</code>, and adapt the type of <code>parensCps</code> accordingly:</p>

<pre><code class="language-haskell">— Type alias in Idris (a function on types)
Cont : Type -&gt; Type -&gt; Type
Cont r a = (a -&gt; r) -&gt; r

parensCps : String -&gt; Cont r String
parensCps s cont = cont ("(" ++ s ++ ")")
</code></pre>

<p>In the code above, the type <code>Cont r a</code> should be understood as “the type of a continuation passing style function returning a <code>a</code>“ with <code>r</code> being the return type of the continuation. Alternatively, we could see <code>Cont r a</code> as the type of a function that leads us one step closer to a final result of type <code>r</code>, where:</p>

<ul>
  <li><code>a</code> is an intermediary step on the way to compute the final result of type <code>r</code></li>
  <li>The continuation <code>a -&gt; r</code> represents the rest of the computation to get to the final result</li>
</ul>

<p>This continuation pattern is the one we will try to find in <code>IOSpec</code>.</p>

<h3 id="iospec-continuation-passing-style">IOSpec continuation passing style</h3>

<p>Looking back at the AST of the <code>IOSpec</code> Free Monad, let us see in what aspects it resembles the continuation passing style of programming. We will start with the definition of the AST:</p>

<pre><code class="language-haskell">data IOSpec a
  = ReadLine (String -&gt; IOSpec a)
  | PrintLine String (IOSpec a)
  | Pure a
</code></pre>

<p>We can  refactor this Algebraic Data Type (ADT) to use the more general syntax of <a href="https://wiki.haskell.org/Generalised_algebraic_datatype">Generalized Algebraic Data Type</a> (GADTs), yielding the following equivalent definition for <code>IOSpec</code>:</p>

<pre><code class="language-haskell">data IOSpec : Type -&gt; Type where
  ReadLine  : (String -&gt; IOSpec a) -&gt; IOSpec a
  PrintLine : String -&gt; (() -&gt; IOSpec a) -&gt; IOSpec a
  Pure      : a -&gt; IOSpec a
</code></pre>

<p>Now, if you look at this carefully, you should start to see that:</p>

<ul>
  <li><code>ReadLine</code> resembles a function written in continuation passing style, returning a string</li>
  <li><code>WriteLine</code> resembles a function written in continuation passing style, returning an empty tuple</li>
</ul>

<p>In fact, we can rewrite our AST using our <code>Cont</code> type alias:</p>

<pre><code class="language-haskell">data IOSpec : Type -&gt; Type where
  ReadLine  : Cont (IOSpec a) String
  PrintLine : String -&gt; Cont (IOSpec a) ()
  Pure      : a -&gt; IOSpec a
</code></pre>

<p><em>Note: We cheated a bit. For <code>PrintLine</code>, we replaced an <code>IOSpec</code> computation by a function taking an empty tuple and returning an <code>IOSpec</code> computation. These things are however semantically equivalent.</em></p>

<h2 id="toward-direct-style-ast-using-gadts">Toward direct style AST using GADTs</h2>

<p>Continuation passing style is arguably a bit complex to understand. Thankfully, we can very often transform a CPS function into a function written in direct style, usually much easier to understand. The same way, we can often refactor an AST written in continuation passing style to an AST written in direct style.</p>

<h3 id="using-gadt-for-a-direct-style-ast">Using GADT for a direct style AST</h3>

<p><a href="https://wiki.haskell.org/Generalised_algebraic_datatype">Generalized Algebraic Data</a> Types allow us to write down the type of the constructors. Each of our constructors is free to return a different type. We can use this to define an AST made of instructions that are not of the same type.</p>

<p>This allows us to do something rather nifty. We can turn any function into an instruction of our AST by lifting the name of the function into a type constructor:</p>

<pre><code class="language-haskell">— Turning the following functions:
writeLine : String -&gt; IOSpec ()
readLine : IOSpec String

— Into data constructors:
data IOSpec : Type -&gt; Type where
  WriteLine : String -&gt; IOSpec ()
  ReadLine : IOSpec String
</code></pre>

<p>As we did for our continuation passing style AST, we can hide the construction of the AST using factories functions. These functions are much easier to write than previously: they just map instructions back to their corresponding functions.</p>

<pre><code class="language-haskell">readLine : IOSpec String
readLine = ReadLine

prnLine : String -&gt; IOSpec ()
prnLine s = WriteLine s
</code></pre>

<p>Starting from this base, we can build a new Free Monad that encode the same language as our previous AST, by simply adding the support for the Monad interface.</p>

<h3 id="making-it-a-monad">Making it a Monad</h3>

<p>To transform our AST into a Free Monad, we can almost mechanically add two additional constructors for our AST, Pure and Bind, which mimic the Monad interface:</p>

<pre><code class="language-haskell">data IOSpec : Type -&gt; Type where
  Pure : a -&gt; IOSpec a
  Bind : IOSpec a -&gt; (a -&gt; IOSpec b) -&gt; IOSpec b
  WriteLine : String -&gt; IOSpec ()
  ReadLine : IOSpec String
</code></pre>

<p>Now, the Monad implementation of <code>IOSpec</code> almost writes itself. It only consists in calling the appropriate constructors, and is much simpler to write than the Monad instance needed for our continuation passing style AST. It is <a href="https://gist.github.com/deque-blog/7ba19ef39a12e55d190d5db45d2b0735">provided here</a> as reference.</p>

<h3 id="a-specification-for-the-interpreters">A specification for the interpreters</h3>

<p>A value of type <code>IOSpec</code> a represents a computation that returns a result of type a. Our GADT-based AST therefore encodes (and enforces!) the following:</p>

<ul>
  <li>Interpreting the <code>ReadLine</code> instruction should return a <code>String</code></li>
  <li>Interpreting the <code>PrintLine</code> instruction should return empty tuple</li>
</ul>

<p>Somehow, this same information was also encoded, although a bit differently, in our initial continuation passing style AST:</p>

<pre><code class="language-haskell">data IOSpec a
  = ReadLine (String -&gt; IOSpec a)
  | PrintLine String (IOSpec a)
  — Missing constructors
</code></pre>

<p>It however required to know a bit about continuations passing style in order to recognize the pattern, and notice it was effectively equivalent to:</p>

<pre><code class="language-haskell">data IOSpec : Type -&gt; Type where
  ReadLine  : Cont (IOSpec a) String
  PrintLine : String -&gt; Cont (IOSpec a) ()
  — Missing constructors
</code></pre>

<p>Our direct style AST is therefore at the same time easier to derive (just lift function to constructors) and easier to read as a <strong>specification for an interpreter</strong> to translate it into lower-level code.</p>

<h3 id="simpler-interpretation">Simpler interpretation</h3>

<p>Because our AST now encodes the specification of its interpretation in a more direct way, writing an interpreter is also much easier. The translation in a lower level language is almost straightforward:</p>

<ul>
  <li><code>Pure</code> translates to <code>pure</code> in the lower level language</li>
  <li><code>Bind</code> translates into <code>&gt;&gt;=</code> between two interpretations</li>
  <li>The other instructions translate to their corresponding lower level instructions</li>
</ul>

<pre><code class="language-haskell">interpret : IOSpec r -&gt; IO r
interpret (Pure a) = pure a
interpret (Bind a f) = interpret a &gt;&gt;= interpret . f
interpret ReadLine = getLine
interpret (WriteLine s) = putStrLn s
</code></pre>

<p>Each instruction but Bind is translated into a non-compound expression. This is simpler than with our continuation passing style AST, whose <a href="https://gist.github.com/deque-blog/8cad537eb1b92f9a204c6c5954018946">interpretation</a> involved both translating instructions and chaining their result with their corresponding continuation.</p>

<h3 id="bind-factors-the-continuation">Bind factors the continuation</h3>

<p>The astute reader might have recognized some continuation passing style creeping in our GADT-based AST, through the <code>Bind</code> constructor.</p>

<pre><code class="language-haskell">data IOSpec : Type -&gt; Type where
  Bind : IOSpec a -&gt; (a -&gt; IOSpec b) -&gt; IOSpec b

— Or, using our Cont type alias	
data IOSpec : Type -&gt; Type where
  Bind : IOSpec a -&gt; Cont (IOSpec b) a
</code></pre>

<p>This is no accident. We can see the same continuation in the very definition of a Monad (*):</p>

<pre><code class="language-haskell">class Monad m where
  (&gt;&gt;=) : m a -&gt; (a -&gt; m b) -&gt; m b

— Or, using our Cont type alias
class Monad m where
  (&gt;&gt;=) : m a -&gt; Cont (m b) a
</code></pre>

<p>What our GADT-based AST does is in fact to factorize the continuation which used to appear in the ReadLine and PrintLine constructors, into a single <code>Bind</code> single constructor. This is partly what makes the AST simpler to understand and the interpreters easier to write.</p>

<p>(*) Basically, we could see the <code>bind</code> operator of a Monad as mapping between a Monadic value and a continuation. In addition, continuations form a Monad too. This connection between Monads and continuations is expressed in more details in <a href="http://blog.sigfpe.com/2008/12/mother-of-all-monads.html">The mother of all Monads</a>.</p>

<h2 id="the-end-of-our-journey">The end of our journey</h2>

<p>There are many different ways to write the same code. Similarly, there is more than one way we can write our Free Monad. In particular, there are two broad categories of Abstract Syntax Trees: continuation passing style ASTs, and direct style ASTs.</p>

<h3 id="continuation-passing-style">Continuation Passing Style</h3>

<p>While continuation passing style is rarely encountered in the wild world of programming, it is relatively more present in the context of Free Monads.</p>

<p>The reason is that constructors of an algebraic data type must all return the same type, such as <code>AST a</code> where <code>a</code> stands for the result type of the overall computation. Therefore, encoding the return type of each instruction is not possible unless:</p>

<ul>
  <li>We rely on something like continuation passing style</li>
  <li>We enable Haskell type extensions such as GADTs</li>
</ul>

<h3 id="switching-to-direct-style">Switching to Direct Style</h3>

<p>Turning up the GADTs extensions gives us the choice not to dive into the tricky world of continuation passing style (which is arguably harder to understand), and get some additional benefits such as:</p>

<ul>
  <li>An almost automatic way to build an AST from the instructions we want it to support</li>
  <li>An AST that acts as easily to understand specification for its interpreters</li>
  <li>Simpler interpreters, factory functions, and Monad instances</li>
</ul>

<p>These benefits makes it much easier to introduce the concept of Free Monad to newcomers to Haskell or Idris, refer to <a href="/blog/2017/07/06/hexagonal-architecture-free-monad.html">this article as an example</a>, and make GADT-based AST a great alternative to continuation passing style ASTs.</p>



        
      </section>

      <footer class="page__meta">
        
        


        

  <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> Updated:</strong> <time datetime="2017-12-08T00:00:00+00:00">December 8, 2017</time></p>


      </footer>

      <section class="page__share">
    
  
    <a href="https://twitter.com/intent/tweet?via=quduval&text=Continuation+passing+style+Free+Monads+and+direct+style+Free+Monads%20%2Fblog%2F2017%2F12%2F08%2Fcps-free-monads.html" class="btn btn--twitter" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Twitter"><i class="fab fa-fw fa-twitter" aria-hidden="true"></i><span> Twitter</span></a>
  
    <a href="https://www.facebook.com/sharer/sharer.php?u=%2Fblog%2F2017%2F12%2F08%2Fcps-free-monads.html" class="btn btn--facebook" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Facebook"><i class="fab fa-fw fa-facebook" aria-hidden="true"></i><span> Facebook</span></a>
  
    <!--
    <a href="https://www.linkedin.com/shareArticle?mini=true&url=%2Fblog%2F2017%2F12%2F08%2Fcps-free-monads.html" class="btn btn--linkedin" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on LinkedIn"><i class="fab fa-fw fa-linkedin" aria-hidden="true"></i><span> LinkedIn</span></a>
    -->
    
    <a href="https://www.reddit.com/submit?url=%2Fblog%2F2017%2F12%2F08%2Fcps-free-monads.html&title=Continuation+passing+style+Free+Monads+and+direct+style+Free+Monads" class="btn" style="background-color: #ff4500; color: white" title=" Reddit"><i class="fab fa-fw fa-reddit" aria-hidden="true"></i><span> Reddit</span></a>

    <a href="http://news.ycombinator.com/submitlink?u=%2Fblog%2F2017%2F12%2F08%2Fcps-free-monads.html&t=Continuation passing style Free Monads and direct style Free Monads" class="btn" style="background-color: #ff6600; color: white"  title=" Hackernews"><i class="fab fa-fw fa-hacker-news" aria-hidden="true"></i><span> Hacker News</span></a>

</section>

      
<div class="post_navi_hr">&nbsp;</div>
<hr class="post_navi_hr">
<div class="post_navi"><a class="post_navi-item nav_prev" href="/blog/2017/12/01/test-polymorphic-haskell.html" title="Answering r/haskell: How to unit test code that uses polymorphic interfaces?">
    <div class="post_navi-arrow">&lt;</div><div class="post_navi-label">Previous Post</div><div><span class="post_navi-title">Answering r/haskell: How to unit test code that uses polymorphic interfaces?</span></div>
  </a><a class="post_navi-item nav_next" href="/blog/2018/07/28/cost-of-ignoring-errors.html" title="Small programming faults can overflow an entire system">
    <div class="post_navi-arrow">&gt;</div><div class="post_navi-label">Next Post</div><div><span class="post_navi-title">Small programming faults can overflow an entire system</span></div>
  </a></div>

    </div>

    
      <div class="page__comments">
  
  
      <h4 class="page__comments-title">Comments</h4>
      <section id="giscus-comments"></section>
    
</div>

    
  </article>

  
  
    <div class="page__related">
      <h4 class="page__related-title">You May Also Enjoy</h4>
      <div class="grid__wrapper">
        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/blog/2022/09/05/statistical-gender-bias.html" rel="permalink">Statistical gender bias
</a>
      
    </h2>
    
        <p class="archive__item-excerpt" itemprop="description">I recently stumbled on a debate where J. Peterson argues that the gender pay gap is mostly not due to gender bias. Let’s see what’s wrong with his argument.
</p>
    
    
<p class="page__meta">

  
    
    <span class="page__meta-date">
      <i class="far fa-calendar-alt" aria-hidden="true"></i>
      
      <time datetime="2022-09-05T00:00:00+00:00">September 5, 2022</time>
      
        &bull; random-rambling
      
    </span>
  

  

  
</p>

  </article>
</div>
        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/blog/2022/06/19/perplexity.html" rel="permalink">Understanding perplexity and its relation to cross-entropy and compression
</a>
      
    </h2>
    
        <p class="archive__item-excerpt" itemprop="description">Modern conditional and unconditional language models often report their perplexity as validation metrics. Let’s see what it means.
</p>
    
    
<p class="page__meta">

  
    
    <span class="page__meta-date">
      <i class="far fa-calendar-alt" aria-hidden="true"></i>
      
      <time datetime="2022-06-19T00:00:00+00:00">June 19, 2022</time>
      
        &bull; machine-learning
      
    </span>
  

  

  
</p>

  </article>
</div>
        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/blog/2022/06/16/lm-joint-probability.html" rel="permalink">Auto-regressive language models don’t necessarily sample the most probable sentences
</a>
      
    </h2>
    
        <p class="archive__item-excerpt" itemprop="description">Have you even tried to sample greedily from a language model. It’s not a good idea. Let’s discuss why.
</p>
    
    
<p class="page__meta">

  
    
    <span class="page__meta-date">
      <i class="far fa-calendar-alt" aria-hidden="true"></i>
      
      <time datetime="2022-06-16T00:00:00+00:00">June 16, 2022</time>
      
        &bull; machine-learning
      
    </span>
  

  

  
</p>

  </article>
</div>
        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/blog/2022/05/24/cycling-drag-force.html" rel="permalink">How wind affects your speed on a bike
</a>
      
    </h2>
    
        <p class="archive__item-excerpt" itemprop="description">Let’s look at how the wind affect your speed on a bike, the diminishing impact of power, and why you feel the drag suddenly passed a certain speed.
</p>
    
    
<p class="page__meta">

  
    
    <span class="page__meta-date">
      <i class="far fa-calendar-alt" aria-hidden="true"></i>
      
      <time datetime="2022-05-24T00:00:00+00:00">May 24, 2022</time>
      
        &bull; random-rambling
      
    </span>
  

  

  
</p>

  </article>
</div>
        
      </div>
    </div>
  
  
</div>

    </div>

    
      <div class="search-content">
        <div class="search-content__inner-wrap"><form class="search-content__form" onkeydown="return event.key != 'Enter';">
    <label class="sr-only" for="search">
      Enter your search term...
    </label>
    <input type="search" id="search" class="search-input" tabindex="-1" placeholder="Enter your search term..." />
  </form>
  <div id="results" class="results"></div></div>

      </div>
    

    <div id="footer" class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        <div class="page__footer-follow">
  <ul class="social-icons">
    

    
      
        
          <li><a href="https://github.com/QuentinDuval" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-github" aria-hidden="true"></i> GitHub</a></li>
        
      
        
          <li><a href="https://twitter.com/quduval" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-twitter-square" aria-hidden="true"></i> Twitter</a></li>
        
      
        
          <li><a href="https://www.linkedin.com/in/quentin-duval-53ba6576/" rel="nofollow noopener noreferrer"><i class="fab fa-linkedin" aria-hidden="true"></i> LinkedIn</a></li>
        
      
    

    
      <li><a href="/feed.xml"><i class="fas fa-fw fa-rss-square" aria-hidden="true"></i> Feed</a></li>
    
  </ul>
</div>

<div class="page__footer-copyright">&copy; 2022 Double Ended Queue. Powered by <a href="https://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://mademistakes.com/work/minimal-mistakes-jekyll-theme/" rel="nofollow">Minimal Mistakes</a>.</div>

      </footer>
    </div>

    
  <script src="/assets/js/main.min.js"></script>




<script src="/assets/js/lunr/lunr.min.js"></script>
<script src="/assets/js/lunr/lunr-store.js"></script>
<script src="/assets/js/lunr/lunr-en.js"></script>




  <script>
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'G-RRHHYN266B']);
  
    _gaq.push(['_gat._anonymizeIp']);
  
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>






    <script>
  'use strict';

  (function () {
    var commentContainer = document.querySelector('#giscus-comments');

    if (!commentContainer) {
      return;
    }

    var script = document.createElement('script');
    script.setAttribute('src', 'https://giscus.app/client.js');
    script.setAttribute('data-repo', 'quentinduval/quentinduval.github.io');
    script.setAttribute('data-repo-id', 'MDEwOlJlcG9zaXRvcnk3MzUyMDE3Nw==');
    script.setAttribute('data-category', 'General');
    script.setAttribute('data-category-id', 'DIC_kwDOBGHUMc4CBKf3');
    script.setAttribute('data-mapping', 'url');
    script.setAttribute('data-reactions-enabled', '1');
    script.setAttribute('data-theme', 'light');
    script.setAttribute('crossorigin', 'anonymous');

    commentContainer.appendChild(script);
  })();
</script>
  





  </body>
</html>
