<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.24.0 by Michael Rose
  Copyright 2013-2020 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>Building a Clojurescript game (POC) - Double Ended Queue</title>
<meta name="description" content="Let us implement a board game in ClojureScript, a functional programming language transpiling to JS, from the game rules to graphics to AI (part 2).">



<meta property="og:type" content="article">
<meta property="og:locale" content="en_US">
<meta property="og:site_name" content="Double Ended Queue">
<meta property="og:title" content="Building a Clojurescript game (POC)">
<meta property="og:url" content="/blog/2017/03/03/building-clojure-game-2.html">


  <meta property="og:description" content="Let us implement a board game in ClojureScript, a functional programming language transpiling to JS, from the game rules to graphics to AI (part 2).">





  <meta name="twitter:site" content="@quduval">
  <meta name="twitter:title" content="Building a Clojurescript game (POC)">
  <meta name="twitter:description" content="Let us implement a board game in ClojureScript, a functional programming language transpiling to JS, from the game rules to graphics to AI (part 2).">
  <meta name="twitter:url" content="/blog/2017/03/03/building-clojure-game-2.html">

  
    <meta name="twitter:card" content="summary">
    
  

  



  <meta property="article:published_time" content="2017-03-03T00:00:00+00:00">






<link rel="canonical" href="/blog/2017/03/03/building-clojure-game-2.html">




<script type="application/ld+json">
  {
    "@context": "https://schema.org",
    
      "@type": "Person",
      "name": null,
      "url": "/"
    
  }
</script>







<!-- end _includes/seo.html -->



  <link href="/feed.xml" type="application/atom+xml" rel="alternate" title="Double Ended Queue Feed">


<!-- https://t.co/dKP3o1e -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">
<!--<link rel="stylesheet" href="/assets/css/overrides.css">-->
<link rel="preload" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5/css/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
<noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5/css/all.min.css"></noscript>

<!-- highlight.js support -->
<!--<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.8/styles/idea.min.css"/>-->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.8/styles/github.min.css"/>
<!--<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.8/styles/default.min.css">-->
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.8/highlight.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.8/languages/clojure.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.8/languages/cpp.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.8/languages/elixir.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.8/languages/haskell.min.js"></script>
<!--<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.8/languages/idris.min.js"></script>-->
<script>hljs.initHighlightingOnLoad();</script>
<!-- end highlight.js support -->

<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jpswalsh/academicons@1/css/academicons.min.css">




    <!-- start custom head snippets -->

<!-- insert favicons. use https://realfavicongenerator.net/ -->

<!-- end custom head snippets -->

  </head>

  <body class="layout--post">
    <nav class="skip-links">
  <ul>
    <li><a href="#site-nav" class="screen-reader-shortcut">Skip to primary navigation</a></li>
    <li><a href="#main" class="screen-reader-shortcut">Skip to content</a></li>
    <li><a href="#footer" class="screen-reader-shortcut">Skip to footer</a></li>
  </ul>
</nav>

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->

    
        

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
        <a class="site-title" href="/blog">
          Double Ended Queue
          <span class="site-subtitle">Functions In, Fictions Out</span>
        </a>
        <ul class="visible-links"><li class="masthead__menu-item">
              <a href="/">About</a>
            </li><li class="masthead__menu-item">
              <a href="/archives/">Archives</a>
            </li><li class="masthead__menu-item">
              <a href="/categories/">Categories</a>
            </li></ul>
        
        <button class="search__toggle" type="button">
          <span class="visually-hidden">Toggle search</span>
          <i class="fas fa-search"></i>
        </button>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">Toggle menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>
    

    <div class="initial-content">
      



<div id="main" role="main">
  
  <div class="sidebar sticky">
  
  
    
      
      
      
      
    
      
      
      
      
    
      
      
      
      
    
      
      
      
      
    
    
    
      <!--Future idea to search on the side bar-->
<!--
<button class="search__toggle" type="button">
    <span class="visually-hidden">Toggle search</span>
    <i class="fas fa-search"></i>
</button>
-->

<nav class="nav__list">
    <ul class="nav__items">
        <li>
            <span class="nav__sub-title">Recent posts</span>
            <ul>
                
                    <li class="sidebar__item"><a href="/blog/2022/09/05/statistical-gender-bias.html">Statistical gender bias</a></li>
                
                    <li class="sidebar__item"><a href="/blog/2022/06/19/perplexity.html">Understanding perplexity and its relation to cross-entropy and compression</a></li>
                
                    <li class="sidebar__item"><a href="/blog/2022/06/16/lm-joint-probability.html">Auto-regressive language models don't necessarily sample the most probable sentences</a></li>
                
                    <li class="sidebar__item"><a href="/blog/2022/05/24/cycling-drag-force.html">How wind affects your speed on a bike</a></li>
                
            </ul>
        </li>
    </ul>
</nav>
    
    
      <nav class="nav__list">
    <ul class="nav__items">
        <li>
            <span class="nav__sub-title">Categories</span>
            <ul>
                
                    
                    <li class="sidebar__item"><a href="/categories/#functional-programming">functional-programming</a></li>
                
                    
                    <li class="sidebar__item"><a href="/categories/#modern-cpp">modern-cpp</a></li>
                
                    
                    <li class="sidebar__item"><a href="/categories/#software-design">software-design</a></li>
                
                    
                    <li class="sidebar__item"><a href="/categories/#system-design">system-design</a></li>
                
                    
                    <li class="sidebar__item"><a href="/categories/#random-rambling">random-rambling</a></li>
                
                    
                    <li class="sidebar__item"><a href="/categories/#machine-learning">machine-learning</a></li>
                
            </ul>
        </li>
    </ul>
</nav>
    
    
      <nav class="nav__list">
    <ul class="nav__items">
        <li>
            <span class="nav__sub-title">Contact info</span>
            <ul class="author__urls social-icons">
                <li><a href="/" rel="nofollow noopener noreferrer"><i class="fas fa-fw fa-link" aria-hidden="true"></i><span class="label">Website</span></a></li>
                <li><a href="https://github.com/QuentinDuval" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-github" aria-hidden="true"></i><span class="label">GitHub</span></a></li>
                <li><a href="https://scholar.google.com/citations?user=XTaVGqYAAAAJ" rel="nofollow noopener noreferrer"><i class="ai ai-google-scholar-square" aria-hidden="true"></i><span class="label">Google Scholar</span></a></li>
                <li><a href="https://twitter.com/quduval" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-twitter-square" aria-hidden="true"></i><span class="label">Twitter</span></a></li>
                <li><a href="https://www.linkedin.com/in/quentin-duval-53ba6576" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-linkedin" aria-hidden="true"></i><span class="label">LinkedIn</span></a></li>
            </ul>
        </li>
    </ul>
</nav>
    
    
  
  </div>


  <article class="page" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="Building a Clojurescript game (POC)">
    <meta itemprop="description" content="Let us implement a board game in ClojureScript, a functional programming language transpiling to JS, from the game rules to graphics to AI (part 2).">
    <meta itemprop="datePublished" content="2017-03-03T00:00:00+00:00">
    

    <div class="page__inner-wrap">
      
        <header>
          <h1 id="page-title" class="page__title" itemprop="headline">Building a Clojurescript game (POC)
</h1>
          

  <p class="page__meta">
    
      
      <span class="page__meta-date">
        <i class="far fa-calendar-alt" aria-hidden="true"></i>
        
        <time datetime="2017-03-03T00:00:00+00:00">March 3, 2017</time>
      </span>
    

    

    <!--
    <span class="page__meta-sep"></span>
    <span>Quentin Duval</span>
    -->

    
  </p>



    




<span id="share-buttons-light-prompt" style="color: silver;">Share on: </span>
<div id="share-buttons-light">
    <div class="twitter"  title="Share this on Twitter"     onclick="window.open('https://twitter.com/intent/tweet?url=%2Fblog%2F2017%2F03%2F03%2Fbuilding-clojure-game-2.html&text=Building+a+Clojurescript+game+%28POC%29&via=','popup','width=600,height=600'); return false;">
        <!--<svg viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg"><path d="M1684 408q-67 98-162 167 1 14 1 42 0 130-38 259.5t-115.5 248.5-184.5 210.5-258 146-323 54.5q-271 0-496-145 35 4 78 4 225 0 401-138-105-2-188-64.5t-114-159.5q33 5 61 5 43 0 85-11-112-23-185.5-111.5t-73.5-205.5v-4q68 38 146 41-66-44-105-115t-39-154q0-88 44-163 121 149 294.5 238.5t371.5 99.5q-8-38-8-74 0-134 94.5-228.5t228.5-94.5q140 0 236 102 109-21 205-78-37 115-142 178 93-10 186-50z"/></svg>-->
        <span class="fab fa-fw fa-twitter share-light share-light-twitter"></span>
    </div>
    <div class="facebook" title="Share this on Facebook"    onclick="window.open('http://www.facebook.com/share.php?u=%2Fblog%2F2017%2F03%2F03%2Fbuilding-clojure-game-2.html','popup','width=600,height=600'); return false;">
        <!--<svg viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg"><path d="M1343 12v264h-157q-86 0-116 36t-30 108v189h293l-39 296h-254v759h-306v-759h-255v-296h255v-218q0-186 104-288.5t277-102.5q147 0 228 12z"/></svg>-->
        <span class="fab fa-fw fa-facebook share-light share-light-facebook"></span>
    </div>
    <div class="linkedin" title="Share this on Linkedin"    onclick="window.open('https://www.linkedin.com/sharing/share-offsite/?url=%2Fblog%2F2017%2F03%2F03%2Fbuilding-clojure-game-2.html','popup','width=600,height=600'); return false;">
        <!--<svg viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg"><path d="M477 625v991h-330v-991h330zm21-306q1 73-50.5 122t-135.5 49h-2q-82 0-132-49t-50-122q0-74 51.5-122.5t134.5-48.5 133 48.5 51 122.5zm1166 729v568h-329v-530q0-105-40.5-164.5t-126.5-59.5q-63 0-105.5 34.5t-63.5 85.5q-11 30-11 81v553h-329q2-399 2-647t-1-296l-1-48h329v144h-2q20-32 41-56t56.5-52 87-43.5 114.5-15.5q171 0 275 113.5t104 332.5z"/></svg>-->
        <span class="fab fa-fw fa-linkedin share-light share-light-linkedin"></span>
    </div>
    <a class="reddit" title="Share this on Reddit" href="http://www.reddit.com/submit?url=/blog/2017/03/03/building-clojure-game-2.html&title=Building a Clojurescript game (POC)"
        onclick="gtag('event', 'Reddit', {'event_category':'Post Shared','event_label':'Reddit'}); window.open(this.href, 'pop-up', 'left=20,top=20,width=900,height=500,toolbar=1,resizable=0'); return false;">
        <span class="fab fa-fw fa-reddit share-light share-light-reddit"></span>
    </a>

    <a title="Share this on Hacker News"
        href="http://news.ycombinator.com/submitlink?u=/blog/2017/03/03/building-clojure-game-2.html&t=Building a Clojurescript game (POC)">
        <span class="fab fa-fw fa-hacker-news share-light share-light-hacker-news"></span>
    </a>
</div>


        </header>
      

      <section class="page__content" itemprop="text">
        
          <aside class="sidebar__right ">
            <nav class="toc">
              <header><h4 class="nav__title"><i class="fas fa-file-alt"></i> Table of content</h4></header>
              <ul class="toc__menu"><li><a href="#summary-of-the-target-architecture">Summary of the target architecture</a></li><li><a href="#tic-tac-toe">Tic Tac Toe</a></li><li><a href="#selecting-data-structures">Selecting data structures</a><ul><li><a href="#entities-and-relationships">Entities and relationships</a></li><li><a href="#possible-representations">Possible representations</a></li><li><a href="#choice-of-board-representation">Choice of board representation</a></li></ul></li><li><a href="#rendering">Rendering</a><ul><li><a href="#callbacks">Callbacks</a></li><li><a href="#main-frame">Main frame</a></li><li><a href="#top-panel">Top panel</a></li><li><a href="#board">Board</a></li></ul></li><li><a href="#game-logic">Game logic</a><ul><li><a href="#board-1">Board</a></li><li><a href="#turn">Turn</a></li><li><a href="#game">Game</a></li></ul></li><li><a href="#plugging-it-together">Plugging it together</a></li><li><a href="#conclusion-and-whats-next">Conclusion and what’s next?</a></li></ul>

            </nav>
          </aside>
        
        <p>This post is the second in the series of posts focused on the conception and implementation of a port in ClojureScript of the game named Tribolo.</p>

<p>In our <a href="/blog/2017/02/27/building-clojure-game-1.html">previous post</a>, we discussed the game, described its rule, and discussed its basic target architecture. This post will use this target architecture to build a much simpler game, a Tic-Tac-Toe, with the goal to make the architecture more explicit.</p>

<p>The Tribolo itself will indeed require several dedicated posts and so the architecture will be distilled through several posts. Building a Tic-Tac-Toe allows us to get the big picture through a Proof-Of-Concept.</p>

<p>To make our POC as useful as possible, our Tic Tac Toe will follow the same basic game mechanics and have the same kind of look and feel that our Tribolo game.</p>

<p>You can try both and see the parallel by yourself:</p>

<ul>
  <li>You can try the Tribolo game we want to build at the <a href="/tribolo/index.html">following address</a>.</li>
  <li>You can try the Tic Tac Toe we will build today at the <a href="/tictactoe/index.html">following address</a>.</li>
</ul>

<h2 id="summary-of-the-target-architecture">Summary of the target architecture</h2>

<p>We begin with a quick review of the target architecture we described in our last post. We first identified the following responsibilities:</p>

<ul>
  <li><strong>Rendering</strong>: transforming the current game state into HTML and SVG</li>
  <li><strong>Game logic</strong>: the rules governing transitions between game states</li>
  <li><strong>AI logic</strong>: selection of the best next move for an AI player</li>
  <li><strong>Store</strong>: the in-memory data-base holding the application state</li>
  <li><strong>Game loop</strong>: coordinates and control of the different aspects</li>
</ul>

<p>Our target architecture uses the traditional decoupling between the view, the game logic (the model) and plugs the elements together though the game loop (the controler):</p>

<pre><code>   Store ----------------&gt; Rendering ---------------&gt; Reagent
     ^      (reaction)         ^      (send hiccup)
     |                         |
     |                         | (listen)
     |       (update)          |
     \-------------------- Game loop
                               |
                               |
     ,-------------------------| (use to update store)
     |                         |
     v                         v
 Game logic &lt;-------------- AI logic
</code></pre>

<p>This is it for the refresher. We will now instantiate this very simple architecture by implementing our Tic Tac Toe, to get a better feel of how it looks like in code.</p>

<h2 id="tic-tac-toe">Tic Tac Toe</h2>

<p>Tic Tac Toe is a pretty simple game. The interesting thing about Tic Tac Toe is that it is quite close to Tribolo. Both are turn based games, both feature a board, both have rules tied to the ownership of the cells of the board by the player, and both our games will feature an undo feature.</p>

<p>All of this makes the Tic Tac Toe a pretty good Proof-Of-Concept for our Tribolo game and its architecture. The only noticeable difference will be the absence of Artificial Intelligence in our Tic Tac Toe.</p>

<p>This part is left out for several reasons:</p>

<ul>
  <li>It will save us time and is not needed to explain the architecture</li>
  <li>The AI is so simple that it would not inform much on the Tribolo AI</li>
</ul>

<h2 id="selecting-data-structures">Selecting data structures</h2>

<p>We will first begin by designing our data structure. The goal is to model our problem, identifying the entities and the relations between them, to help us reason about the code better during implementation.</p>

<h3 id="entities-and-relationships">Entities and relationships</h3>

<p>We identify the following concepts: a cell, a board and a player.</p>

<p>A <strong>cell</strong> is something that a <strong>player</strong> can own and is identified by a coordinate (two integers). The game is made of 9 cells, which together form the <strong>board</strong>.</p>

<p>We are interested in the following relationships between these entities:</p>

<ul>
  <li>The notion of ownership of a cell by a player</li>
  <li>Winning cell sets: a player owning one entire set wins the game</li>
</ul>

<p>A <strong>turn</strong> represents a given state of Tic Tac Toe: the ownership of the cells by the different players, and the next player to play. We will define a <strong>game</strong> as a succession of <strong>turn</strong> with valid transitions between them.</p>

<h3 id="possible-representations">Possible representations</h3>

<p>We can represent <strong>cells</strong> by their natural identifier on the board, their coordinate x and y. We can use the two keywords <code>:cross</code> and <code>:circle</code> to represent each of our <strong>player</strong>. Winning cell sets can be represented as sets of coordinates. A game can be represented as a vector of turn.</p>

<p>Then, there are at least two ways we can represent the ownership of cells by players:</p>

<p><em>Choice 1</em>: We could choose to maintain two sets of cells, one for each player. A cell (x,y) being owned by the player P would be represented as (x,y) being in the set of cells associated to player P. Identifying a winner is done by checking if the set of a player includes a winning cell set.</p>

<p>Technically, a turn would be represented as:</p>

<pre><code class="language-clj">{:board {:owner/cross #{[0 0] [1 0]} ;; Cells owned by "cross"
         :owner/circle #{[0 2]}}     ;; Cells owned by "circle"
 :player :owner/circle}              ;; Next player to play
</code></pre>

<p><em>Choice 2</em>: We could choose to model the ownership of the cells the other way around. Each cell would be associated a owner, or <code>:none</code> if not owned. The board could be an associative container from cells to players that own them. Identifying a winner is done by accessing the map for each winning cell set, and check if it is fully owned by a single player.</p>

<p>Technically, a turn would be represented as:</p>

<pre><code class="language-clj">{:board {[0 1] :owner/none,
         [1 2] :owner/none,
         [0 0] :owner/cross,
         [2 2] :owner/none,
         [0 2] :owner/circle,
         [1 1] :owner/none,
         [2 1] :owner/none,
         [1 0] :owner/cross,
         [2 0] :owner/none},
 :player :owner/circle}
</code></pre>

<p>There are potential variations on this representation as well. We could choose to omit the cells that do not have owners and use nil to represent the absence of owner. Or we could choose to use a vector of vector to hold the owners.</p>

<h3 id="choice-of-board-representation">Choice of board representation</h3>

<p>For our implementation, we will follow <em>choice 2</em> and maintain a board associating cells to their respective owners. A game being is succession of turns. So our game will be a vector of maps that each represent a turn:</p>

<pre><code class="language-clj">[{:board {[0 1] :owner/none,
          [1 2] :owner/none,
          ;; More associations ...
          [2 0] :owner/none},
  :player :owner/cross},
 {:board {[0 1] :owner/none,
          [0 0] :owner/cross,
          ;; More associations ...
          [2 0] :owner/none},
  :player :owner/circle}]
</code></pre>

<p><em>Note: We could have tried the representation described in choice 1 or decided not omit cells that are not owned as well. If we tried these representations, we would need to provide a function to list explicitly all the valid coordinates of the board (for the rendering especially). But being more explicit about the valid coordinates allows to have a more generic implementation. For example, we could implement a more exotic Tic Tac Toe where the grid is replaced by a more funky shape. We encourage you to try this option.</em></p>

<h2 id="rendering">Rendering</h2>

<p>Because ClojureScript, Reagent and Fighwheel offer together such a dynamic experience, we will start with the rendering of turn. Doing so will help us have quick feedback on the game logic as we develop it.</p>

<h3 id="callbacks">Callbacks</h3>

<p>A sound choice of architecture dictates us that our view must be independent of the statement management of the game, which we named <strong>game store</strong>.</p>

<p>The usual solution is to use some form of callbacks to decouple these two parts. Although we could make use of a protocol there, we will use a simpler alternative: a map holding the different callbacks functions.</p>

<p>In the rendering code that follows, this map of function will be referred to as callbacks. It will hold the keywords <code>:on-move</code>, <code>:on-restart</code>, <code>:on-undo</code> to represent each of the actions that can be triggered by the user.</p>

<h3 id="main-frame">Main frame</h3>

<p>We want the main frame of our game to be composed of a top panel, holding actions like restart game and undo last move, on top of the representation of the game board, a 3 times 3 grid.</p>

<p>We can represent this easily by creating a namespace frame holding a function render that simply delegates the rendering of the different parts to their associated namespaces, panel and board.</p>

<pre><code class="language-clj">(ns tictactoe.view.frame
  (:require
    [tictactoe.view.board :as board]
    [tictactoe.view.panel :as panel]))


(defn render
  "Rendering the main frame of the game,
   takes as input the callbacks to trigger events"
  [{:keys [board] :as turn} callbacks]
  [:div
   [panel/render-top-panel turn callbacks]
   [board/render-board board callbacks]
   ])
</code></pre>

<h3 id="top-panel">Top panel</h3>

<p>Rendering the top panel of the game is pretty straightforward. We will display two buttons, surrounding a “Tic Tac Toe” title that changes to “Draw Game”, “Cross wins” or “Circle wins” when we reach the end of the game.</p>

<pre><code class="language-clj">(defn- make-button
  [on-click txt]
  [:button.top-button {:on-click on-click} txt])

(defn render-top-panel
  "Render the top panel:
   * The restart game button
   * The title of the game
   * The undo button"
  [turn {:keys [on-restart on-undo]}]
  [:div.scores
   [make-button on-restart utils/circle-arrow]
   [:h1#title (title/get-title turn)]
   [make-button on-undo utils/back-arrow]
   ])
</code></pre>

<p>This code makes use of two callbacks <code>on-restart-event</code> and <code>on-undo-event</code> that are linked do their corresponding button. The caller of the frame will have to provide the associated callbacks in the map callbacks.</p>

<p>This code also makes use of utilities to create a circle arrow or back arrow. This code is not particularly interesting but is included <a href="https://gist.github.com/deque-blog/93924f49165f6137f2a8e3517ad2a4f5">in this Gist</a> for completeness. The same goes for get-title that computes the title of the game available <a href="https://gist.github.com/deque-blog/3428159e9e958f96c1a6e0b6b5774cc8">in this Gist</a>.</p>

<h3 id="board">Board</h3>

<p>Rendering the board of the game consists in creating a SVG panel and filling it with the SVG representation of each cells. Using some helper functions, we can write it in a pretty simple way:</p>

<pre><code class="language-clj">(defn render-board
  "Render the board:
   * Creates a SVG panel
   * Render the cells in it"
  [board {:keys [on-move]}]
  (utils/square-svg-panel
    {:model-size board/size
     :pixel-size cst/board-pixel-size}
    (for [cell board]
      [cell/render-cell cell on-move]
      )))
</code></pre>

<p>This code makes use of the rendering functions for the cells. Each cell is rendered differently based on the owner of the cell:</p>

<pre><code class="language-clj">(defn render-cell
  "Dispatch the rendering of the cell based on the player"
  [[coord owner :as cell] on-move]
  (let [renderer (case owner
                   :owner/cross render-cross
                   :owner/circle render-circle
                   render-square)]
    (renderer coord {:on-click #(on-move coord)})))
</code></pre>

<p>Although we could have used multi-methods to dispatch to the right rendering function, we choose not to. The number of player is fixed and we did not need any customization points.</p>

<p>To finish the rendering of the board, we need to take care of the cells. As this is a bit tedious to play with SVG, we will skip this part. You can refer to the link to the GitHub repo at the end of the post if you are curious.</p>

<h2 id="game-logic">Game logic</h2>

<p>We now have everything we need to display our game. It is great time to move to the implementation of the game logic.</p>

<p>We will build this game logic from the bottom up:</p>

<ul>
  <li>Start with the board: the association of coordinates to their owner</li>
  <li>Continue with the turn: the core of the game logic and its rules</li>
  <li>Finish with the game: the succession of turn that make up a full game</li>
</ul>

<h3 id="board-1">Board</h3>

<p>Our implementation of the board will rely on some useful constants:</p>

<ul>
  <li>The size of the board (width and height are equal)</li>
  <li>The vector of valid coordinates on the board</li>
  <li>The empty board where each cell has no associated owner</li>
</ul>

<pre><code class="language-clj">(def size "The size of the board" 3)

(def coordinates
  "All the valid coordinates on the board"
  (for [x (range size) y (range size)] [x y]))

(def coordinates? (set coordinates))

(def empty-board (zipmap coordinates (repeat :owner/none)))
</code></pre>

<p>The code of the board is rather boring. It merely consists in wrapping operations around the associative container from coordinates to owners. This wrapping is not necessary. We only introduced it to add some assertions and give more specific names.</p>

<pre><code class="language-clj">(defn get-owner-at
  "Get the owner associated to the cell"
  [board coord]
  {:pre [(coordinates? coord)]}
  (get board coord))

(defn has-owner?
  "Check whether the coord has an owner associated to it"
  [board coord]
  {:pre [(coordinates? coord)]}
  (not= (get-owner-at board coord) :owner/none))

(defn convert-cell
  "Assign the cell [x y] to a new player"
  [board player coord]
  {:pre [(coordinates? coord)
         (not (has-owner? board coord))]}
  (assoc board coord player))

(defn full-board?
  "Verifies whether the board has any empty cell left"
  [board]
  (not-any? #{:owner/none} (vals board)))
</code></pre>

<h3 id="turn">Turn</h3>

<p>The turn represents the state of the game at a particular point. It holds both the state of the board and the next player to play. The main function attached to a turn is the ability to compute the <code>next-turn</code> from a turn and a coordinate.</p>

<p>The next turn is obtained by converting the cell targeted at the provided coordinate to assign it to the current player. This process only makes sense if the game is not over and if the target coordinate is valid (not owned yet and inside the board):</p>

<pre><code class="language-clj">(defn next-turn
  "Convert a cell to the player color and switch player"
  [turn coord]
  (if-not (or (game-over? turn) (invalid-move? turn coord))
    (-&gt; turn
      (update :board board/convert-cell (:player turn) coord)
      (update :player next-player))))
</code></pre>

<p>The function above makes use of several helper functions. We will focus on the most interesting one: <code>game-over?</code>. A game is over if either the board is entirely filled, or if a player has won:</p>

<pre><code class="language-clj">(defn game-over?
  "The game is over if either:
   * The board is full
   * There is a winner"
  [{:keys [board]}]
  (or
    (board/full-board? board)
    (has-winner? board)))
</code></pre>

<p>Identifying the winner consists in verifying if a given player owns at least one winning combination of cells. This <code>get-winner</code> functin makes use of the <code>sole-owner</code> function to check if a combination of cells is entirely owned by one given player:</p>

<ul>
  <li>We retrieve the owners of each of the cells</li>
  <li>We put these owners in a set to remove duplicates</li>
  <li>Singleton sets allow us to identify potential winners</li>
</ul>

<pre><code class="language-clj">(defn- sole-owner
  "Indicates whether all positions are owned by the same player"
  [board positions]
  (let [owners (set (map #(board/get-owner-at board %) positions))]
    (case owners
      #{:owner/circle} :owner/circle
      #{:owner/cross} :owner/cross
      nil)))

(defn get-winner
  "Return the winner, or nil if the game has none"
  [{:keys [board]}]
  (some #(sole-owner board %) winning-cell-sets))
</code></pre>

<p>The interesting part about this approach is that the rules specifying the winning conditions are entirely extracted as winning cell sets:</p>

<pre><code class="language-clj">(def winning-diags
  [(filter #(= (first %) (second %)) board/coordinates)
   (filter #(= (dec board/size) (reduce + %)) board/coordinates)])

(def winning-rows (partition board/size board/coordinates))
(def winning-lines (algo/transpose winning-rows))
(def winning-cell-sets (concat winning-rows winning-lines winning-diags))
</code></pre>

<p>We can easily change these rules by playing with this data alone. For example we could decide that owning all the corners makes you a winner: to do so, we add a set of winning cell containing [0 0], [0 2], [2 0], and [2 2].</p>

<h3 id="game">Game</h3>

<p>To finish modeling our Tic Tac Toe game logic, we are left with implementing the game, the succession of turns. This is quite straightforward:</p>

<ul>
  <li>The start of the game is a vector with only the start turn (empty board)</li>
  <li>Playing a turn calls <code>next-turn</code> and adds a new value onto the stack</li>
  <li>The current turn of the game is therefore the one at the top of the stack</li>
  <li>To undo the last a move is to pop the last turn from the stack</li>
</ul>

<pre><code class="language-clj">(defn new-game []
  [turn/start-turn])

(defn current-turn
  [game]
  (peek game))

(defn play-move
  "Play current player move at the provided coordinate"
  [game coord]
  (if-let [new-turn (turn/next-turn (current-turn game) coord)]
    (conj game new-turn)
    game))

(defn undo-last-move
  "Remove the last game if there is enough game played"
  [game]
  (if (&lt; 1 (count game)) (pop game) game))

(defn handle-event
  "Callback to dispath the event on the game"
  [game event]
  (cond
    (= event :restart) (new-game)
    (= event :undo) (undo-last-move game)
    :else (play-move game event)
    ))
</code></pre>

<h2 id="plugging-it-together">Plugging it together</h2>

<p>Our game logic is done. The rendering is ready to display a turn in our game. We only need to deal with state management and plug all these different parts together.</p>

<p>The state management is pretty light. It consists of an <code>ratom</code> to hold the current state of the game, a <code>reation</code> to access the current turn of the game, and a few functions to deal with event handling:</p>

<pre><code class="language-clj">(defonce app-state (reagent/atom (logic/new-game)))
(def current-turn (reaction (logic/current-turn @app-state)))
(defn send-event! [e] (swap! app-state logic/handle-event e))

(defn handle-event
  "Dispath the event to the game logic, yielding a new game"
  [game event]
  (cond
    (= event :restart) (new-game)
    (= event :undo) (undo-last-move game)
    :else (play-move game event)))
</code></pre>

<p>To finish up, plugging the GUI with the state management and the callbacks to the game logic is done in main rendering function:</p>

<pre><code class="language-clj">(defn tic-tac-toe
  "Main entry point, assemble:
   * the game state
   * the game view"
  []
  [frame/render @store/current-turn
   {:on-restart #(store/send-event! :restart)
    :on-undo #(store/send-event! :undo)
    :on-move #(store/send-event! %)}])

(reagent/render [tic-tac-toe]
  (js/document.getElementById "app"))
</code></pre>

<p>We are done. Apart from some boring code that we did not listed in this post, the game is now fully functional (pun intended).</p>

<h2 id="conclusion-and-whats-next">Conclusion and what’s next?</h2>

<p>Through the implementation of a Tic-Tac-Toe, we went over the basic architecture we will follow to build our <a href="/tribolo/index.html">Tribolo</a> game. You can find the full implementation of our Tic-Tac-Toe in this <a href="https://github.com/deque-blog/tictactoe/tree/master/src/cljs/tictactoe">GitHub repository</a>.</p>

<p>Doing this Proof-Of-Concept demonstrated us how simple and effective this architectural style is, and how good it is at separating concerns:</p>

<ul>
  <li>Our game logic is pure and not concerned with state management</li>
  <li>Our GUI is only concerned about the turn representation</li>
  <li>The top namespace of the software is the only one knowing all the pieces</li>
</ul>

<p>As far as the game logic is concerned, the events could come from the network
Now that our architecture is pretty clear and seems working, our next task will be to develop the Tribolo game based on it. This will be the subject of the next posts.</p>


        
      </section>

      <footer class="page__meta">
        
        


        

  <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> Updated:</strong> <time datetime="2017-03-03T00:00:00+00:00">March 3, 2017</time></p>


      </footer>

      <section class="page__share">
    
  
    <a href="https://twitter.com/intent/tweet?via=quduval&text=Building+a+Clojurescript+game+%28POC%29%20%2Fblog%2F2017%2F03%2F03%2Fbuilding-clojure-game-2.html" class="btn btn--twitter" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Twitter"><i class="fab fa-fw fa-twitter" aria-hidden="true"></i><span> Twitter</span></a>
  
    <a href="https://www.facebook.com/sharer/sharer.php?u=%2Fblog%2F2017%2F03%2F03%2Fbuilding-clojure-game-2.html" class="btn btn--facebook" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Facebook"><i class="fab fa-fw fa-facebook" aria-hidden="true"></i><span> Facebook</span></a>
  
    <!--
    <a href="https://www.linkedin.com/shareArticle?mini=true&url=%2Fblog%2F2017%2F03%2F03%2Fbuilding-clojure-game-2.html" class="btn btn--linkedin" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on LinkedIn"><i class="fab fa-fw fa-linkedin" aria-hidden="true"></i><span> LinkedIn</span></a>
    -->
    
    <a href="https://www.reddit.com/submit?url=%2Fblog%2F2017%2F03%2F03%2Fbuilding-clojure-game-2.html&title=Building+a+Clojurescript+game+%28POC%29" class="btn" style="background-color: #ff4500; color: white" title=" Reddit"><i class="fab fa-fw fa-reddit" aria-hidden="true"></i><span> Reddit</span></a>

    <a href="http://news.ycombinator.com/submitlink?u=%2Fblog%2F2017%2F03%2F03%2Fbuilding-clojure-game-2.html&t=Building a Clojurescript game (POC)" class="btn" style="background-color: #ff6600; color: white"  title=" Hackernews"><i class="fab fa-fw fa-hacker-news" aria-hidden="true"></i><span> Hacker News</span></a>

</section>

      
<div class="post_navi_hr">&nbsp;</div>
<hr class="post_navi_hr">
<div class="post_navi"><a class="post_navi-item nav_prev" href="/blog/2017/02/27/building-clojure-game-1.html" title="Building a Clojurescript game">
    <div class="post_navi-arrow">&lt;</div><div class="post_navi-label">Previous Post</div><div><span class="post_navi-title">Building a Clojurescript game</span></div>
  </a><a class="post_navi-item nav_next" href="/blog/2017/03/10/building-clojure-game-3.html" title="Building a Clojurescript Game Logic">
    <div class="post_navi-arrow">&gt;</div><div class="post_navi-label">Next Post</div><div><span class="post_navi-title">Building a Clojurescript Game Logic</span></div>
  </a></div>

    </div>

    
      <div class="page__comments">
  
  
      <h4 class="page__comments-title">Comments</h4>
      <section id="giscus-comments"></section>
    
</div>

    
  </article>

  
  
    <div class="page__related">
      <h4 class="page__related-title">You May Also Enjoy</h4>
      <div class="grid__wrapper">
        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/blog/2022/09/05/statistical-gender-bias.html" rel="permalink">Statistical gender bias
</a>
      
    </h2>
    
        <p class="archive__item-excerpt" itemprop="description">I recently stumbled on a debate where J. Peterson argues that the gender pay gap is mostly not due to gender bias. Let’s see what’s wrong with his argument.
</p>
    
    
<p class="page__meta">

  
    
    <span class="page__meta-date">
      <i class="far fa-calendar-alt" aria-hidden="true"></i>
      
      <time datetime="2022-09-05T00:00:00+00:00">September 5, 2022</time>
      
        &bull; random-rambling
      
    </span>
  

  

  
</p>

  </article>
</div>
        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/blog/2022/06/19/perplexity.html" rel="permalink">Understanding perplexity and its relation to cross-entropy and compression
</a>
      
    </h2>
    
        <p class="archive__item-excerpt" itemprop="description">Modern conditional and unconditional language models often report their perplexity as validation metrics. Let’s see what it means.
</p>
    
    
<p class="page__meta">

  
    
    <span class="page__meta-date">
      <i class="far fa-calendar-alt" aria-hidden="true"></i>
      
      <time datetime="2022-06-19T00:00:00+00:00">June 19, 2022</time>
      
        &bull; machine-learning
      
    </span>
  

  

  
</p>

  </article>
</div>
        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/blog/2022/06/16/lm-joint-probability.html" rel="permalink">Auto-regressive language models don’t necessarily sample the most probable sentences
</a>
      
    </h2>
    
        <p class="archive__item-excerpt" itemprop="description">Have you even tried to sample greedily from a language model. It’s not a good idea. Let’s discuss why.
</p>
    
    
<p class="page__meta">

  
    
    <span class="page__meta-date">
      <i class="far fa-calendar-alt" aria-hidden="true"></i>
      
      <time datetime="2022-06-16T00:00:00+00:00">June 16, 2022</time>
      
        &bull; machine-learning
      
    </span>
  

  

  
</p>

  </article>
</div>
        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/blog/2022/05/24/cycling-drag-force.html" rel="permalink">How wind affects your speed on a bike
</a>
      
    </h2>
    
        <p class="archive__item-excerpt" itemprop="description">Let’s look at how the wind affect your speed on a bike, the diminishing impact of power, and why you feel the drag suddenly passed a certain speed.
</p>
    
    
<p class="page__meta">

  
    
    <span class="page__meta-date">
      <i class="far fa-calendar-alt" aria-hidden="true"></i>
      
      <time datetime="2022-05-24T00:00:00+00:00">May 24, 2022</time>
      
        &bull; random-rambling
      
    </span>
  

  

  
</p>

  </article>
</div>
        
      </div>
    </div>
  
  
</div>

    </div>

    
      <div class="search-content">
        <div class="search-content__inner-wrap"><form class="search-content__form" onkeydown="return event.key != 'Enter';">
    <label class="sr-only" for="search">
      Enter your search term...
    </label>
    <input type="search" id="search" class="search-input" tabindex="-1" placeholder="Enter your search term..." />
  </form>
  <div id="results" class="results"></div></div>

      </div>
    

    <div id="footer" class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        <div class="page__footer-follow">
  <ul class="social-icons">
    

    
      
        
          <li><a href="https://github.com/QuentinDuval" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-github" aria-hidden="true"></i> GitHub</a></li>
        
      
        
          <li><a href="https://twitter.com/quduval" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-twitter-square" aria-hidden="true"></i> Twitter</a></li>
        
      
        
          <li><a href="https://www.linkedin.com/in/quentin-duval-53ba6576/" rel="nofollow noopener noreferrer"><i class="fab fa-linkedin" aria-hidden="true"></i> LinkedIn</a></li>
        
      
    

    
      <li><a href="/feed.xml"><i class="fas fa-fw fa-rss-square" aria-hidden="true"></i> Feed</a></li>
    
  </ul>
</div>

<div class="page__footer-copyright">&copy; 2022 Double Ended Queue. Powered by <a href="https://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://mademistakes.com/work/minimal-mistakes-jekyll-theme/" rel="nofollow">Minimal Mistakes</a>.</div>

      </footer>
    </div>

    
  <script src="/assets/js/main.min.js"></script>




<script src="/assets/js/lunr/lunr.min.js"></script>
<script src="/assets/js/lunr/lunr-store.js"></script>
<script src="/assets/js/lunr/lunr-en.js"></script>




  <script>
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'G-RRHHYN266B']);
  
    _gaq.push(['_gat._anonymizeIp']);
  
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>






    <script>
  'use strict';

  (function () {
    var commentContainer = document.querySelector('#giscus-comments');

    if (!commentContainer) {
      return;
    }

    var script = document.createElement('script');
    script.setAttribute('src', 'https://giscus.app/client.js');
    script.setAttribute('data-repo', 'quentinduval/quentinduval.github.io');
    script.setAttribute('data-repo-id', 'MDEwOlJlcG9zaXRvcnk3MzUyMDE3Nw==');
    script.setAttribute('data-category', 'General');
    script.setAttribute('data-category-id', 'DIC_kwDOBGHUMc4CBKf3');
    script.setAttribute('data-mapping', 'url');
    script.setAttribute('data-reactions-enabled', '1');
    script.setAttribute('data-theme', 'light');
    script.setAttribute('crossorigin', 'anonymous');

    commentContainer.appendChild(script);
  })();
</script>
  





  </body>
</html>
