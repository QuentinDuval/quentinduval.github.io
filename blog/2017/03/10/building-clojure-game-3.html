<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.24.0 by Michael Rose
  Copyright 2013-2020 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>Building a Clojurescript Game Logic - Double Ended Queue</title>
<meta name="description" content="Let us implement a board game in ClojureScript, a functional programming language transpiling to JS, from the game rules to graphics to AI (part 3).">



<meta property="og:type" content="article">
<meta property="og:locale" content="en_US">
<meta property="og:site_name" content="Double Ended Queue">
<meta property="og:title" content="Building a Clojurescript Game Logic">
<meta property="og:url" content="/blog/2017/03/10/building-clojure-game-3.html">


  <meta property="og:description" content="Let us implement a board game in ClojureScript, a functional programming language transpiling to JS, from the game rules to graphics to AI (part 3).">





  <meta name="twitter:site" content="@quduval">
  <meta name="twitter:title" content="Building a Clojurescript Game Logic">
  <meta name="twitter:description" content="Let us implement a board game in ClojureScript, a functional programming language transpiling to JS, from the game rules to graphics to AI (part 3).">
  <meta name="twitter:url" content="/blog/2017/03/10/building-clojure-game-3.html">

  
    <meta name="twitter:card" content="summary">
    
  

  



  <meta property="article:published_time" content="2017-03-10T00:00:00+00:00">






<link rel="canonical" href="/blog/2017/03/10/building-clojure-game-3.html">




<script type="application/ld+json">
  {
    "@context": "https://schema.org",
    
      "@type": "Person",
      "name": null,
      "url": "/"
    
  }
</script>







<!-- end _includes/seo.html -->



  <link href="/feed.xml" type="application/atom+xml" rel="alternate" title="Double Ended Queue Feed">


<!-- https://t.co/dKP3o1e -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">
<!--<link rel="stylesheet" href="/assets/css/overrides.css">-->
<link rel="preload" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5/css/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
<noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5/css/all.min.css"></noscript>

<!-- highlight.js support -->
<!--<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.8/styles/idea.min.css"/>-->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.8/styles/github.min.css"/>
<!--<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.8/styles/default.min.css">-->
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.8/highlight.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.8/languages/clojure.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.8/languages/cpp.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.8/languages/elixir.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.8/languages/haskell.min.js"></script>
<!--<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.8/languages/idris.min.js"></script>-->
<script>hljs.initHighlightingOnLoad();</script>
<!-- end highlight.js support -->

<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jpswalsh/academicons@1/css/academicons.min.css">




    <!-- start custom head snippets -->

<!-- insert favicons. use https://realfavicongenerator.net/ -->

<!-- end custom head snippets -->

  </head>

  <body class="layout--post">
    <nav class="skip-links">
  <ul>
    <li><a href="#site-nav" class="screen-reader-shortcut">Skip to primary navigation</a></li>
    <li><a href="#main" class="screen-reader-shortcut">Skip to content</a></li>
    <li><a href="#footer" class="screen-reader-shortcut">Skip to footer</a></li>
  </ul>
</nav>

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->

    
        

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
        <a class="site-title" href="/blog">
          Double Ended Queue
          <span class="site-subtitle">Functions In, Fictions Out</span>
        </a>
        <ul class="visible-links"><li class="masthead__menu-item">
              <a href="/">About</a>
            </li><li class="masthead__menu-item">
              <a href="/archives/">Archives</a>
            </li><li class="masthead__menu-item">
              <a href="/categories/">Categories</a>
            </li></ul>
        
        <button class="search__toggle" type="button">
          <span class="visually-hidden">Toggle search</span>
          <i class="fas fa-search"></i>
        </button>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">Toggle menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>
    

    <div class="initial-content">
      



<div id="main" role="main">
  
  <div class="sidebar sticky">
  
  
    
      
      
      
      
    
      
      
      
      
    
      
      
      
      
    
      
      
      
      
    
    
    
      <!--Future idea to search on the side bar-->
<!--
<button class="search__toggle" type="button">
    <span class="visually-hidden">Toggle search</span>
    <i class="fas fa-search"></i>
</button>
-->

<nav class="nav__list">
    <ul class="nav__items">
        <li>
            <span class="nav__sub-title">Recent posts</span>
            <ul>
                
                    <li class="sidebar__item"><a href="/blog/2022/09/05/statistical-gender-bias.html">Statistical gender bias</a></li>
                
                    <li class="sidebar__item"><a href="/blog/2022/06/19/perplexity.html">Understanding perplexity and its relation to cross-entropy and compression</a></li>
                
                    <li class="sidebar__item"><a href="/blog/2022/06/16/lm-joint-probability.html">Auto-regressive language models don't necessarily sample the most probable sentences</a></li>
                
                    <li class="sidebar__item"><a href="/blog/2022/05/24/cycling-drag-force.html">How wind affects your speed on a bike</a></li>
                
            </ul>
        </li>
    </ul>
</nav>
    
    
      <nav class="nav__list">
    <ul class="nav__items">
        <li>
            <span class="nav__sub-title">Categories</span>
            <ul>
                
                    
                    <li class="sidebar__item"><a href="/categories/#functional-programming">functional-programming</a></li>
                
                    
                    <li class="sidebar__item"><a href="/categories/#modern-cpp">modern-cpp</a></li>
                
                    
                    <li class="sidebar__item"><a href="/categories/#software-design">software-design</a></li>
                
                    
                    <li class="sidebar__item"><a href="/categories/#system-design">system-design</a></li>
                
                    
                    <li class="sidebar__item"><a href="/categories/#random-rambling">random-rambling</a></li>
                
                    
                    <li class="sidebar__item"><a href="/categories/#machine-learning">machine-learning</a></li>
                
            </ul>
        </li>
    </ul>
</nav>
    
    
      <nav class="nav__list">
    <ul class="nav__items">
        <li>
            <span class="nav__sub-title">Contact info</span>
            <ul class="author__urls social-icons">
                <li><a href="/" rel="nofollow noopener noreferrer"><i class="fas fa-fw fa-link" aria-hidden="true"></i><span class="label">Website</span></a></li>
                <li><a href="https://github.com/QuentinDuval" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-github" aria-hidden="true"></i><span class="label">GitHub</span></a></li>
                <li><a href="https://scholar.google.com/citations?user=XTaVGqYAAAAJ" rel="nofollow noopener noreferrer"><i class="ai ai-google-scholar-square" aria-hidden="true"></i><span class="label">Google Scholar</span></a></li>
                <li><a href="https://twitter.com/quduval" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-twitter-square" aria-hidden="true"></i><span class="label">Twitter</span></a></li>
                <li><a href="https://www.linkedin.com/in/quentin-duval-53ba6576" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-linkedin" aria-hidden="true"></i><span class="label">LinkedIn</span></a></li>
            </ul>
        </li>
    </ul>
</nav>
    
    
  
  </div>


  <article class="page" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="Building a Clojurescript Game Logic">
    <meta itemprop="description" content="Let us implement a board game in ClojureScript, a functional programming language transpiling to JS, from the game rules to graphics to AI (part 3).">
    <meta itemprop="datePublished" content="2017-03-10T00:00:00+00:00">
    

    <div class="page__inner-wrap">
      
        <header>
          <h1 id="page-title" class="page__title" itemprop="headline">Building a Clojurescript Game Logic
</h1>
          

  <p class="page__meta">
    
      
      <span class="page__meta-date">
        <i class="far fa-calendar-alt" aria-hidden="true"></i>
        
        <time datetime="2017-03-10T00:00:00+00:00">March 10, 2017</time>
      </span>
    

    

    <!--
    <span class="page__meta-sep"></span>
    <span>Quentin Duval</span>
    -->

    
  </p>



    




<span id="share-buttons-light-prompt" style="color: silver;">Share on: </span>
<div id="share-buttons-light">
    <div class="twitter"  title="Share this on Twitter"     onclick="window.open('https://twitter.com/intent/tweet?url=%2Fblog%2F2017%2F03%2F10%2Fbuilding-clojure-game-3.html&text=Building+a+Clojurescript+Game+Logic&via=','popup','width=600,height=600'); return false;">
        <!--<svg viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg"><path d="M1684 408q-67 98-162 167 1 14 1 42 0 130-38 259.5t-115.5 248.5-184.5 210.5-258 146-323 54.5q-271 0-496-145 35 4 78 4 225 0 401-138-105-2-188-64.5t-114-159.5q33 5 61 5 43 0 85-11-112-23-185.5-111.5t-73.5-205.5v-4q68 38 146 41-66-44-105-115t-39-154q0-88 44-163 121 149 294.5 238.5t371.5 99.5q-8-38-8-74 0-134 94.5-228.5t228.5-94.5q140 0 236 102 109-21 205-78-37 115-142 178 93-10 186-50z"/></svg>-->
        <span class="fab fa-fw fa-twitter share-light share-light-twitter"></span>
    </div>
    <div class="facebook" title="Share this on Facebook"    onclick="window.open('http://www.facebook.com/share.php?u=%2Fblog%2F2017%2F03%2F10%2Fbuilding-clojure-game-3.html','popup','width=600,height=600'); return false;">
        <!--<svg viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg"><path d="M1343 12v264h-157q-86 0-116 36t-30 108v189h293l-39 296h-254v759h-306v-759h-255v-296h255v-218q0-186 104-288.5t277-102.5q147 0 228 12z"/></svg>-->
        <span class="fab fa-fw fa-facebook share-light share-light-facebook"></span>
    </div>
    <div class="linkedin" title="Share this on Linkedin"    onclick="window.open('https://www.linkedin.com/sharing/share-offsite/?url=%2Fblog%2F2017%2F03%2F10%2Fbuilding-clojure-game-3.html','popup','width=600,height=600'); return false;">
        <!--<svg viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg"><path d="M477 625v991h-330v-991h330zm21-306q1 73-50.5 122t-135.5 49h-2q-82 0-132-49t-50-122q0-74 51.5-122.5t134.5-48.5 133 48.5 51 122.5zm1166 729v568h-329v-530q0-105-40.5-164.5t-126.5-59.5q-63 0-105.5 34.5t-63.5 85.5q-11 30-11 81v553h-329q2-399 2-647t-1-296l-1-48h329v144h-2q20-32 41-56t56.5-52 87-43.5 114.5-15.5q171 0 275 113.5t104 332.5z"/></svg>-->
        <span class="fab fa-fw fa-linkedin share-light share-light-linkedin"></span>
    </div>
    <a class="reddit" title="Share this on Reddit" href="http://www.reddit.com/submit?url=/blog/2017/03/10/building-clojure-game-3.html&title=Building a Clojurescript Game Logic"
        onclick="gtag('event', 'Reddit', {'event_category':'Post Shared','event_label':'Reddit'}); window.open(this.href, 'pop-up', 'left=20,top=20,width=900,height=500,toolbar=1,resizable=0'); return false;">
        <span class="fab fa-fw fa-reddit share-light share-light-reddit"></span>
    </a>

    <a title="Share this on Hacker News"
        href="http://news.ycombinator.com/submitlink?u=/blog/2017/03/10/building-clojure-game-3.html&t=Building a Clojurescript Game Logic">
        <span class="fab fa-fw fa-hacker-news share-light share-light-hacker-news"></span>
    </a>
</div>


        </header>
      

      <section class="page__content" itemprop="text">
        
          <aside class="sidebar__right ">
            <nav class="toc">
              <header><h4 class="nav__title"><i class="fas fa-file-alt"></i> Table of content</h4></header>
              <ul class="toc__menu"><li><a href="#entities-and-relationships">Entities and relationships</a></li><li><a href="#high-level-design">High level design</a><ul><li><a href="#board">Board</a></li><li><a href="#turn">Turn</a></li><li><a href="#game">Game</a></li></ul></li><li><a href="#board-1">Board</a><ul><li><a href="#data-structures">Data structures</a></li><li><a href="#specs-of-the-api">Specs of the API</a></li><li><a href="#implementation">Implementation</a></li></ul></li><li><a href="#turn-1">Turn</a><ul><li><a href="#data-structure">Data structure</a></li><li><a href="#specs-of-the-api-1">Specs of the API</a></li><li><a href="#implementatoin-transition">Implementatoin (transition)</a></li><li><a href="#implementation-next-turn">Implementation (next-turn)</a></li><li><a href="#implementation-next-player">Implementation (next-player)</a></li></ul></li><li><a href="#computing-transitions">Computing transitions</a><ul><li><a href="#performance-constraints">Performance constraints</a></li><li><a href="#algorithm">Algorithm</a></li><li><a href="#thoughts-on-implementation">Thoughts on implementation</a></li><li><a href="#chosen-algorithm">Chosen algorithm</a></li><li><a href="#scanning-and-grouping">Scanning and grouping</a></li><li><a href="#finding-jumps-from-a-destination-point">Finding jumps from a destination point</a></li></ul></li><li><a href="#game-1">Game</a></li><li><a href="#conclusion-and-whats-next">Conclusion and what’s next?</a></li></ul>

            </nav>
          </aside>
        
        <p>This post is the third in the series of posts focused on the design and implementation of a port in ClojureScript of a board game named Tribolo.</p>

<p>In our <a href="/blog/2017/02/27/building-clojure-game-1.html">first post</a>, we discussed the game, described its rules and came up with a basic target architecture. In our <a href="/blog/2017/03/03/building-clojure-game-2.html">second post</a>, we tested this architecture on a Proof-Of-Concept. We built a Tic Tac Toe to make sure the architecture was sound.</p>

<p>This post will go through the development of the game logic of our Tribolo game, from the definition of the main entities and relationships, to the implementation choices made. The full game is available and playable at this address.</p>

<p><em>Note: This post builds on top of the previous two posts. In particular, it assumes the reader understands the rules of Tribolo. You can refer to our first post to review these rules.</em></p>

<h2 id="entities-and-relationships">Entities and relationships</h2>

<p>Our first step before going into the implementation will be to think about the different concepts that make up the Tribolo game. Each of the words in <strong>bold</strong> below underlines an important concept of the game.</p>

<p>Like the Tic Tac Toe game we built in our earlier post, the game is all about <strong>player</strong> fighting for the ownership of <strong>cells</strong>. Cells can be identified by a two dimension coordinate. The <strong>board</strong> is the collection of the the cells of the game.</p>

<p>A <strong>game</strong> is made of a succession of <strong>turn</strong>. Each turn represents a valid point in time in a complete game. Unlike the Tic Tac Toe though, cells can change owners over the course of the game. The rules to transfer ownership of cells are specific enough to deserve a name.</p>

<p>We will designate as <strong>transition</strong> a valid progression from one turn a next turn. There might be several transitions available from a given turn. Each of these transition leads to a new turn. Playing a move can be viewed as following a transition.</p>

<p>A transition between turns consists in realizing one or several <strong>jump</strong>. Each jump does convert the set of cells it went over. A given jump can only convert cells belonging to one opponent.</p>

<p>The <strong>score</strong> of a player is the total amount of cells owned by the player. The player with the highest score at the final turn is the winner.</p>

<h2 id="high-level-design">High level design</h2>

<p>In the previous section, we figured the concepts we want to represent. Let us try to refine them by associated them some kind of high level API. This API will be our guide during the implementation.</p>

<h3 id="board">Board</h3>

<p>The Board allows to represent the concept of ownership of a cell. Much like in the Tic Tac Toe game, its main goal is to maintain a set of associations from coordinates to their associated owner. The main operations are:</p>

<ul>
  <li>The creation of a new board</li>
  <li>The conversion of a cell to a new owner</li>
  <li>The retrieval of a cell’s associated owner</li>
  <li>The traversal of all associations (for rendering)</li>
</ul>

<p>In Haskell-ish notation, it would match the following function prototypes (where IO characterizes impure functions):</p>

<pre><code class="language-hs">new-board :: IO Board
convert-cell :: Board -&gt; Coord -&gt; Player -&gt; Board
get-owner-at :: Board -&gt; Coord -&gt; Player
to-seq :: Board -&gt; [(Coord, Player)]
</code></pre>

<h3 id="turn">Turn</h3>

<p>A turn represents a given state of the game. It gives access to the board, the scores, and the next player to play.</p>

<pre><code class="language-hs">board :: Turn -&gt; Board
player :: Turn -&gt; Player
scores :: Turn -&gt; Scores
</code></pre>

<p>The main operations on a turn are:</p>

<ul>
  <li>To create a new starting turn (when we create a new game)</li>
  <li>To compute the transitions available from this turn</li>
  <li>To follow one of these transitions (playing a move)</li>
</ul>

<pre><code class="language-hs">
new-init-turn :: IO Turn
transitions :: Turn -&gt; Map Coord Transition
next-turn :: Turn -&gt; Transition -&gt; Turn
</code></pre>

<h3 id="game">Game</h3>

<p>To finish up, we can provide a very simple API for the game. From a game, we should be able to extract the current turn, play a move at a given coordinate, and go back to the previous player move (undo).</p>

<pre><code class="language-hs">new-game :: IO Game
current-turn :: Game -&gt; Turn
play-at :: Game -&gt; Coord -&gt; Game
undo-player-move :: Game -&gt; Game
</code></pre>

<h2 id="board-1">Board</h2>

<p>We will start with the implementation of the board. The goal of this component is to maintain a list of associations from coordinates to their respective owners.</p>

<h3 id="data-structures">Data structures</h3>

<p>In the Tic Tac Toe, we choose to implement the Board with an associative container from coordinates to players. For the sake of experimenting something else, we will settle for a vector of vector of owners.</p>

<p>The outer vector stores the column by column index. The inner vectors stores the player by row index. The main advantages of using this representation is that we can give it a nice spec with the size included in it:</p>

<pre><code class="language-clj">(def width 16)
(def height 11)

(s/def ::board
  (s/every
    (s/every ::player/owner :count height)
    :count width))
</code></pre>

<p>We can provide an instance of an empty board, which will be helpful when we will need to instantiate a new board:</p>

<pre><code class="language-clj">(def empty-board
  "An empty board of `width` columns times `height` owners"
  (let [empty-column (vec (repeat height :none))]
    (vec (repeat width empty-column))))
</code></pre>

<h3 id="specs-of-the-api">Specs of the API</h3>

<p>Given the high level API we provided in the last section, we can derive the following specs for our board API:</p>

<pre><code class="language-clj">(s/fdef new-board
  :ret ::board)

(s/fdef convert-cell
  :args (s/cat :board ::board
               :coord ::coord
               :owner ::player/player)
  :ret ::board)

(s/fdef get-owner-at
  :args (s/cat :board ::board
               :coord ::coord)
  :ret ::player/player)

(s/fdef to-seq
  :args (s/cat :board ::board)
  :ret (s/every (s/tuple ::coord ::player/owner)))
</code></pre>

<p>These specifications make use of the specification for coordinates (which makes use of the fact that sets are predicates in Clojure):</p>

<pre><code class="language-clj">(def coordinates
  (vec (for [x (range width)
             y (range height)]
         [x y])))

(s/def ::coord (set coordinates))
</code></pre>

<h3 id="implementation">Implementation</h3>

<p>Most of the implementation for the board API is straightforward. The only interesting bit is the implementation of the <code>new-board</code> function.</p>

<p>A new board must contain 12 randomly located walls, and 12 randomly chosen cells owned by each player. These four sets of 12 cells must be disjoint.</p>

<p>We implement a generic algorithm that will handle the task of picking n elements and attribute them to each element of groups. The core algorithm <code>pick-n-for-each</code> is free of randomness:</p>

<pre><code class="language-clj">(defn zip
  "Create a sequence of tuples, each element being drawn from one collection"
  [&amp; colls]
  (apply map vector colls))

(defn pick-n-of-each
  "Pick n `elements` for each of the `groups` starting from the beginning"
  [n elements groups]
  (zip elements (mapcat #(repeat n %) groups)))

(defn randomly-pick-n-of-each
  "Pick n `elements` for each of the `groups` randomly"
  [n elements groups]
  (pick-n-of-each n (shuffle elements) groups))
</code></pre>

<p>Because we isolated the randomness side-effect from the core algorithm, we can convince ourselves that it works properly by writing some tests around it:</p>

<pre><code class="language-clj">(deftest test-pick-n-of-each
  (let [pick-n-of-each (comp vec algo/pick-n-of-each)]
    (testing "Varying number of each group"
      (are
        [expected n] (= expected (pick-n-of-each n (range) [:a :b]))
        [] 0
        [[0 :a] [1 :b]] 1
        [[0 :a] [1 :a] [2 :b] [3 :b]] 2
        ))
    (testing "Varying number of groups"
      (are
        [expected groups] (= expected (pick-n-of-each 2 (range) groups))
        [] []
        [[0 :a] [1 :a]] [:a]
        ))
    (testing "No elements to choose from"
      (is
        (= [] (pick-n-of-each 1 [] [:a]))
        ))))
</code></pre>

<p>We can then use the algorithm to implement our <code>new-board</code> function by choosing as elements the coordinates on the board, and as groups the players plus the wall:</p>

<pre><code class="language-clj">(defn new-board
  "Creates a new board with initial positions of each players"
  []
  (-&gt;&gt;
    (conj player/all :wall)
    (algo/randomly-pick-n-of-each cst/init-block-count coordinates)
    (reduce
      (fn [board [coord owner]] (convert-cell board coord owner))
      empty-board)))
</code></pre>

<h2 id="turn-1">Turn</h2>

<p>We will continue our implementation with the turn. The turn is the component that hosts most of the game logic of our Tribolo. It is quite large. So we will split its implementation in two:</p>

<ul>
  <li>This section will deal with the turn itself and its representation</li>
  <li>The next section will zoom on the computation of the transitions</li>
</ul>

<h3 id="data-structure">Data structure</h3>

<p>A turn gives us access to current state of the board, the next player to play and the scores. We will use a simple map to store that information, and encode its schema in the following spec:</p>

<pre><code class="language-clj">;; Imported from "triboard.logic.scores.cljs"
(s/def ::scores
  (s/map-of ::player/player int?))

(s/def ::turn
  (s/keys :req-un
    [::board/board
     ::player/player
     ::scores/scores]))
</code></pre>

<p>The representation of transitions is a bit trickier. There are many different possible implementations available. We could represent transitions as functions from turn to turn. We could try to create a protocol for it.</p>

<p>But because Clojure loves data, we will represent these transitions as data. A transition will be a collection jumps, with each jump being a standard map, holding:</p>

<ul>
  <li>The destination of the jump (an empty cell)</li>
  <li>The player winning the cells jumped over</li>
  <li>The player loosing the cells jumped over</li>
  <li>The coordinates of the cells jumped over</li>
</ul>

<p>We can therefore describe a jump and a transition using the specs that follow:</p>

<pre><code class="language-clj">(s/def ::destination ::board/coord)
(s/def ::taken (s/coll-of ::board/coord))
(s/def ::winner ::player/player)
(s/def ::looser ::player/player)

(s/def ::jump
  (s/keys :req-un [::destination ::taken ::winner ::looser]))

(s/def ::transition (s/every ::jump))
</code></pre>

<h3 id="specs-of-the-api-1">Specs of the API</h3>

<p>We can also spec the main functions of our Turn API, based on the previous specs for jump and transitions (which we isolated to the namespace transition):</p>

<pre><code class="language-clj">(s/fdef next-turn
  :args (s/cat :turn ::turn
               :transition ::transition/transition)
  :ret ::turn)

(s/fdef transitions
  :args (s/cat :turn ::turn)
  :ret (s/map-of ::transition/destination ::transition/transition))
</code></pre>

<h3 id="implementatoin-transition">Implementatoin (transition)</h3>

<p>We might expect the transitions function to be quite complex. Its implementation is in fact quite simple: we only access the field of the turn data structure:</p>

<pre><code class="language-clj">(defn transitions
  "Return the transitions available for the next player"
  [turn]
  (:transitions turn))
</code></pre>

<p>This is due to the rules of Tribolo. A player may not have any available transition to play. If so, he passes his turn and we consider the next player in the list. We must then repeat the same again or move to the next player.</p>

<p>As a consequence, to implement <code>next-turn </code>and find the next player to play, we must compute the transitions of the newly created turn. We keep this computation cached inside the turn for optimization purposes.</p>

<h3 id="implementation-next-turn">Implementation (next-turn)</h3>

<p>To compute the next turn of a game from a previous turn and a transition, we will go through three steps:</p>

<ul>
  <li>We modify the board to take into account the jumps</li>
  <li>We modify the scores to be aligned with the new board</li>
  <li>We find the next player to play by looking at available transitions</li>
</ul>

<pre><code class="language-clj">(defn next-turn
  "Apply the transtion to the current turn, yielding a new turn"
  [turn transition]
  (-&gt; turn
    (update :board transition/apply-transition transition)
    (update :scores scores/update-scores transition)
    (with-next-player)))
</code></pre>

<p>The functions <code>apply-transitions</code> and <code>update-scores</code> scan the transitions and update the board and the scores respectively. The interesting part is the computation of the next player, which we will describe below.</p>

<h3 id="implementation-next-player">Implementation (next-player)</h3>

<p>As discussed earlier, finding the next player to play requires to evaluate the transitions available from our current turn.</p>

<p>We search for the first player that has at least a move to play. We temporarily assume the existence of a function <code>transition/all-transitions</code> that return a map from player to their respective available transitions.</p>

<pre><code class="language-clj">(defn- who-can-play
  "Given the current player and the transitions for the next turn,
   returns the next player that has at least one transition available"
  [player transitions]
  (filter                         ;; Keep only the players which
    #(contains? transitions %)    ;; have at least a valid move to play
    (player/next-three player)))  ;; from the next three players

(defn- with-next-player
  "Complete the turn to compute to find the next player than can act
   * Requires to look-ahead for the next possible transitions
   * To save computation, keep this look-ahead available"
  [{:keys [board player] :as turn}]
  (let [transitions (transition/all-transitions board)
        next-player (first (who-can-play player transitions))]
    (merge turn
      {:transitions (get transitions next-player) ;; Keep the transitions of player
       :player next-player})))                    ;; Inside the turn (caching)
</code></pre>

<p>This ends up the implementation of the turn. The only missing part is the implementation of <code>all-transitions</code>. This is the subject of the next section.</p>

<h2 id="computing-transitions">Computing transitions</h2>

<p>We will now discuss the implementation of the Tribolo game logic core: the identification of all the valid transitions from a given board. This means identifying all the possible jumps that can be done by any player, before grouping them by winning player and jump destination coordinate.</p>

<h3 id="performance-constraints">Performance constraints</h3>

<p>The computation of the transitions from a given turn is the most CPU intensive task of the whole game. This will be especially true when we will go into the design and implementation of our AI.</p>

<p>As a consequence, the code that follows makes use of JavaScript arrays over ClojureScript vectors. This simple optimization trick brought nearly a 2X improvement on the AI. The same motivation is behind the use of low level loop-recur constructs in the following algorithms.</p>

<h3 id="algorithm">Algorithm</h3>

<p>The goal of the algorithm is to identify the jumps and then to group them by jump destination and player. A potential jump is a contiguous sequence of cells owned by the same player. It becomes a real jump if it is surrounded by:</p>

<ul>
  <li>A cell with no owner: the destination of the jump</li>
  <li>A cell with another owner: the winner of the jump</li>
</ul>

<p>This contiguous sequence of cell must follow an row, a column, or a diagonal of the board. A wall on either side means there can be no jump.</p>

<h3 id="thoughts-on-implementation">Thoughts on implementation</h3>

<p>We can visualize an implementation based on the use of the partition and partition-by algorithms:</p>

<ul>
  <li>Using partition-by on cells to identify contiguous sequences of owners</li>
  <li>Using partition to group contiguous sequences by window of three</li>
</ul>

<p>This idea is demonstrated below in the REPL on the first row of a sample board. It would have to be done for each row, each column, and each diagonal:</p>

<pre><code class="language-clj">;; Partitioning by owner of the board gives contiguous sequences
(let [first-line (map vector (repeat 0) (range 0 16))]
  (partition-by #(board/get-owner-at board %) first-line))

;; Contiguous sequences of coordinates
=&gt;
(([0 0]) ([0 1] [0 2] [0 3] [0 4]) ([0 5])
 ([0 6]) ([0 7]) ([0 8] [0 9]) ([0 10])
 ([0 11] [0 12] [0 13] [0 14] [0 15]))

;; Making some windows out of it
(partition 3 1 *1)
=&gt;
((([0 0]) ([0 1] [0 2] [0 3] [0 4]) ([0 5])) ;; First window
 (([0 1] [0 2] [0 3] [0 4]) ([0 5]) ([0 6])) ;; Second window
 (([0 5]) ([0 6]) ([0 7]))
 (([0 6]) ([0 7]) ([0 8] [0 9]))
 (([0 7]) ([0 8] [0 9]) ([0 10]))
 (([0 8] [0 9]) ([0 10]) ([0 11] [0 12] [0 13] [0 14] [0 15])))
</code></pre>

<p>This algorithm would “touch” every cell 4 times (one for each direction), leading to 16 times 11 times 4 cell reads, for a total of 704. This algorithm is nice and fine, but it is not the one we will implement. I could not find a way to make it fast enough.</p>

<h3 id="chosen-algorithm">Chosen algorithm</h3>

<p>The algorithm we will implement is much more naive than the one described above. We will scan each empty cell and check in each direction if it is the destination of a jump.</p>

<p>This is not optimal: we will touch the cells more times than with our previous algorithm. It will require around 1200 cell reads at the start of the game, going down when the number of empty cells decreases.</p>

<p>This also looks quite naive as we could try to keep some of that computation between turns. It would require tracing what jumps are invalidated by another jump, which does not seem trivial.</p>

<h3 id="scanning-and-grouping">Scanning and grouping</h3>

<p>We will start by the implementation of the outer loop of the algorithm. This loop will scan every single cell of the board, compute all the available jumps from this position, and group them by player and jump destination.</p>

<p>As indicated before in the performance constraints section, this algorithm needs to be pretty fast, and makes use of a conversion to a JavaScript array at the start:</p>

<pre><code class="language-clj">(defn all-transitions
  [board]
  (let [aboard (board/board-&gt;array board)]    ;; Convert to JS array
    (transduce
      (mapcat #(available-jumps-at aboard %)) ;; Compute jumps at a given position
      (group-by-reducer :winner :destination) ;; Group by jump winner and destination
      board/coordinates)))
</code></pre>

<p>This code makes use of the <code>group-by-reducer</code> helper function, which allows to group elements by on several projections into a nested map as output:</p>

<pre><code class="language-clj">(defn group-by-reducer
  "Create a reducer that groups by the provided key"
  [&amp; key-fns]
  (fn
    ([] {})
    ([result] result)
    ([result val]
      (let [keys ((apply juxt key-fns) val)]
        (update-in result keys conj val)))))
</code></pre>

<h3 id="finding-jumps-from-a-destination-point">Finding jumps from a destination point</h3>

<p>To find the jumps available at a given position, the destination of the jump, we start at an empty cell (not owned by any player).</p>

<p>We then move from the destination point in a fixed direction. The first player we meet is the looser of the potential jump. We continue until we find a cell with a different owner. This player is the winner of the jump.</p>

<p>We collect the coordinates along the way to identify the “jumped over” cells (in the taken vector) until we reach the second player. In case we hit a wall or another empty cell first, we stop the exploration: there is no valid jump in the searched direction. We also watch for going out of the board.</p>

<p>This algorithm translates to the following code, which searches for a jump in a fixed direction from the destination of the jump:</p>

<pre><code class="language-clj">(defn- ^boolean block-jump? [owner]
  (or (= owner :none) (= owner :wall)))

(defn- ^boolean jump-start? [looser owner]
  (and looser (not= looser owner)))

(defn- ^boolean in-board? [x y]
  (and (&lt; -1 x board/width) (&lt; -1 y board/height)))

(defn- seek-jump-source-toward
  "Starting from the destination of a jump (a non-owned cell):
   * Search for valid source for the jump
   * Collect the jumped cells along the way"
  [board [x-init y-init :as jump-destination] [dx dy]]
  (loop [x (+ x-init dx)
         y (+ y-init dy)
         looser nil
         taken []]
    (if (in-board? x y)
      (let [owner (aget board x y)]
        (cond
          (block-jump? owner) nil
          (jump-start? looser owner) {:winner owner
                                      :looser looser
                                      :destination jump-destination
                                      :taken taken}
          :else (recur
                  (+ x dx)
                  (+ y dy)
                  owner
                  (conj taken [x y])))
        ))))
</code></pre>

<p>We have to repeat this algorithm for each possible jump direction. We ignore the empty cells since they cannot be the destination of a jump:</p>

<pre><code class="language-clj">(defn- ^boolean empty-cell?
  [board [x y]]
  (= :none (aget board x y)))

(defn- available-jumps-at
  "Provides the list of jumps that can be done at a given `jump-destination`"
  [board jump-destination]
  (if (empty-cell? board jump-destination)
    (eduction
      (keep #(seek-jump-source-toward board jump-destination %))
      cst/directions)))
</code></pre>

<h2 id="game-1">Game</h2>

<p>The last missing piece of the game logic is the implementation of the game. The game is simply a succession of turn. We can translate the high level API we gave to it into the following specs:</p>

<pre><code class="language-clj">(s/def ::game (s/coll-of ::turn/turn))

(s/fdef current-turn
  :args (s/cat :game ::game)
  :ret ::turn/turn)

(s/fdef play-move
  :args (s/cat :game ::game
               :coord ::board/coord)
  :ret ::game)

(s/fdef undo-player-move
  :args (s/cat :game ::game)
  :ret ::game)
</code></pre>

<p>Its implementation is not terribly thrilling. It is like the implementation we used for Tic Tac Toe with one twist: the undo may go back several turns to find the last turn of the human player. The implementation is listed in this <a href="https://gist.github.com/deque-blog/b23732d75a2a1ab4f06242202faa37b6">GitHub Gist</a> for completeness.</p>

<h2 id="conclusion-and-whats-next">Conclusion and what’s next?</h2>

<p>In this (pretty long) post, we went over the complete game logic of the Tribolo game, from the high level design to the implementation.</p>

<p>In the next posts, we will continue this journey and see how we can implement the other aspects of the game (Artificial Intelligence, User Interface, Game Loop, etc.).</p>

<p>But before we do that, we will spend the next post on discussing the use we made of Clojure Spec inside the game logic we implemented today.</p>


        
      </section>

      <footer class="page__meta">
        
        


        

  <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> Updated:</strong> <time datetime="2017-03-10T00:00:00+00:00">March 10, 2017</time></p>


      </footer>

      <section class="page__share">
    
  
    <a href="https://twitter.com/intent/tweet?via=quduval&text=Building+a+Clojurescript+Game+Logic%20%2Fblog%2F2017%2F03%2F10%2Fbuilding-clojure-game-3.html" class="btn btn--twitter" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Twitter"><i class="fab fa-fw fa-twitter" aria-hidden="true"></i><span> Twitter</span></a>
  
    <a href="https://www.facebook.com/sharer/sharer.php?u=%2Fblog%2F2017%2F03%2F10%2Fbuilding-clojure-game-3.html" class="btn btn--facebook" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Facebook"><i class="fab fa-fw fa-facebook" aria-hidden="true"></i><span> Facebook</span></a>
  
    <!--
    <a href="https://www.linkedin.com/shareArticle?mini=true&url=%2Fblog%2F2017%2F03%2F10%2Fbuilding-clojure-game-3.html" class="btn btn--linkedin" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on LinkedIn"><i class="fab fa-fw fa-linkedin" aria-hidden="true"></i><span> LinkedIn</span></a>
    -->
    
    <a href="https://www.reddit.com/submit?url=%2Fblog%2F2017%2F03%2F10%2Fbuilding-clojure-game-3.html&title=Building+a+Clojurescript+Game+Logic" class="btn" style="background-color: #ff4500; color: white" title=" Reddit"><i class="fab fa-fw fa-reddit" aria-hidden="true"></i><span> Reddit</span></a>

    <a href="http://news.ycombinator.com/submitlink?u=%2Fblog%2F2017%2F03%2F10%2Fbuilding-clojure-game-3.html&t=Building a Clojurescript Game Logic" class="btn" style="background-color: #ff6600; color: white"  title=" Hackernews"><i class="fab fa-fw fa-hacker-news" aria-hidden="true"></i><span> Hacker News</span></a>

</section>

      
<div class="post_navi_hr">&nbsp;</div>
<hr class="post_navi_hr">
<div class="post_navi"><a class="post_navi-item nav_prev" href="/blog/2017/03/03/building-clojure-game-2.html" title="Building a Clojurescript game (POC)">
    <div class="post_navi-arrow">&lt;</div><div class="post_navi-label">Previous Post</div><div><span class="post_navi-title">Building a Clojurescript game (POC)</span></div>
  </a><a class="post_navi-item nav_next" href="/blog/2017/03/31/paramorph-dsl-cpp.html" title="Paramorph your DSL (C++)">
    <div class="post_navi-arrow">&gt;</div><div class="post_navi-label">Next Post</div><div><span class="post_navi-title">Paramorph your DSL (C++)</span></div>
  </a></div>

    </div>

    
      <div class="page__comments">
  
  
      <h4 class="page__comments-title">Comments</h4>
      <section id="giscus-comments"></section>
    
</div>

    
  </article>

  
  
    <div class="page__related">
      <h4 class="page__related-title">You May Also Enjoy</h4>
      <div class="grid__wrapper">
        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/blog/2022/09/05/statistical-gender-bias.html" rel="permalink">Statistical gender bias
</a>
      
    </h2>
    
        <p class="archive__item-excerpt" itemprop="description">I recently stumbled on a debate where J. Peterson argues that the gender pay gap is mostly not due to gender bias. Let’s see what’s wrong with his argument.
</p>
    
    
<p class="page__meta">

  
    
    <span class="page__meta-date">
      <i class="far fa-calendar-alt" aria-hidden="true"></i>
      
      <time datetime="2022-09-05T00:00:00+00:00">September 5, 2022</time>
      
        &bull; random-rambling
      
    </span>
  

  

  
</p>

  </article>
</div>
        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/blog/2022/06/19/perplexity.html" rel="permalink">Understanding perplexity and its relation to cross-entropy and compression
</a>
      
    </h2>
    
        <p class="archive__item-excerpt" itemprop="description">Modern conditional and unconditional language models often report their perplexity as validation metrics. Let’s see what it means.
</p>
    
    
<p class="page__meta">

  
    
    <span class="page__meta-date">
      <i class="far fa-calendar-alt" aria-hidden="true"></i>
      
      <time datetime="2022-06-19T00:00:00+00:00">June 19, 2022</time>
      
        &bull; machine-learning
      
    </span>
  

  

  
</p>

  </article>
</div>
        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/blog/2022/06/16/lm-joint-probability.html" rel="permalink">Auto-regressive language models don’t necessarily sample the most probable sentences
</a>
      
    </h2>
    
        <p class="archive__item-excerpt" itemprop="description">Have you even tried to sample greedily from a language model. It’s not a good idea. Let’s discuss why.
</p>
    
    
<p class="page__meta">

  
    
    <span class="page__meta-date">
      <i class="far fa-calendar-alt" aria-hidden="true"></i>
      
      <time datetime="2022-06-16T00:00:00+00:00">June 16, 2022</time>
      
        &bull; machine-learning
      
    </span>
  

  

  
</p>

  </article>
</div>
        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/blog/2022/05/24/cycling-drag-force.html" rel="permalink">How wind affects your speed on a bike
</a>
      
    </h2>
    
        <p class="archive__item-excerpt" itemprop="description">Let’s look at how the wind affect your speed on a bike, the diminishing impact of power, and why you feel the drag suddenly passed a certain speed.
</p>
    
    
<p class="page__meta">

  
    
    <span class="page__meta-date">
      <i class="far fa-calendar-alt" aria-hidden="true"></i>
      
      <time datetime="2022-05-24T00:00:00+00:00">May 24, 2022</time>
      
        &bull; random-rambling
      
    </span>
  

  

  
</p>

  </article>
</div>
        
      </div>
    </div>
  
  
</div>

    </div>

    
      <div class="search-content">
        <div class="search-content__inner-wrap"><form class="search-content__form" onkeydown="return event.key != 'Enter';">
    <label class="sr-only" for="search">
      Enter your search term...
    </label>
    <input type="search" id="search" class="search-input" tabindex="-1" placeholder="Enter your search term..." />
  </form>
  <div id="results" class="results"></div></div>

      </div>
    

    <div id="footer" class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        <div class="page__footer-follow">
  <ul class="social-icons">
    

    
      
        
          <li><a href="https://github.com/QuentinDuval" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-github" aria-hidden="true"></i> GitHub</a></li>
        
      
        
          <li><a href="https://twitter.com/quduval" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-twitter-square" aria-hidden="true"></i> Twitter</a></li>
        
      
        
          <li><a href="https://www.linkedin.com/in/quentin-duval-53ba6576/" rel="nofollow noopener noreferrer"><i class="fab fa-linkedin" aria-hidden="true"></i> LinkedIn</a></li>
        
      
    

    
      <li><a href="/feed.xml"><i class="fas fa-fw fa-rss-square" aria-hidden="true"></i> Feed</a></li>
    
  </ul>
</div>

<div class="page__footer-copyright">&copy; 2022 Double Ended Queue. Powered by <a href="https://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://mademistakes.com/work/minimal-mistakes-jekyll-theme/" rel="nofollow">Minimal Mistakes</a>.</div>

      </footer>
    </div>

    
  <script src="/assets/js/main.min.js"></script>




<script src="/assets/js/lunr/lunr.min.js"></script>
<script src="/assets/js/lunr/lunr-store.js"></script>
<script src="/assets/js/lunr/lunr-en.js"></script>




  <script>
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'G-RRHHYN266B']);
  
    _gaq.push(['_gat._anonymizeIp']);
  
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>






    <script>
  'use strict';

  (function () {
    var commentContainer = document.querySelector('#giscus-comments');

    if (!commentContainer) {
      return;
    }

    var script = document.createElement('script');
    script.setAttribute('src', 'https://giscus.app/client.js');
    script.setAttribute('data-repo', 'quentinduval/quentinduval.github.io');
    script.setAttribute('data-repo-id', 'MDEwOlJlcG9zaXRvcnk3MzUyMDE3Nw==');
    script.setAttribute('data-category', 'General');
    script.setAttribute('data-category-id', 'DIC_kwDOBGHUMc4CBKf3');
    script.setAttribute('data-mapping', 'url');
    script.setAttribute('data-reactions-enabled', '1');
    script.setAttribute('data-theme', 'light');
    script.setAttribute('crossorigin', 'anonymous');

    commentContainer.appendChild(script);
  })();
</script>
  





  </body>
</html>
