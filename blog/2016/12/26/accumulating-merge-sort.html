<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.24.0 by Michael Rose
  Copyright 2013-2020 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>Accumulating merge sort (C++) - Double Ended Queue</title>
<meta name="description" content="Implementing a merge sort in terms of a std::accumulate (left to right scan) is possible. Here is how to merge sort using only ForwardIterators.">



<meta property="og:type" content="article">
<meta property="og:locale" content="en_US">
<meta property="og:site_name" content="Double Ended Queue">
<meta property="og:title" content="Accumulating merge sort (C++)">
<meta property="og:url" content="/blog/2016/12/26/accumulating-merge-sort.html">


  <meta property="og:description" content="Implementing a merge sort in terms of a std::accumulate (left to right scan) is possible. Here is how to merge sort using only ForwardIterators.">





  <meta name="twitter:site" content="@quduval">
  <meta name="twitter:title" content="Accumulating merge sort (C++)">
  <meta name="twitter:description" content="Implementing a merge sort in terms of a std::accumulate (left to right scan) is possible. Here is how to merge sort using only ForwardIterators.">
  <meta name="twitter:url" content="/blog/2016/12/26/accumulating-merge-sort.html">

  
    <meta name="twitter:card" content="summary">
    
  

  



  <meta property="article:published_time" content="2016-12-26T00:00:00+00:00">






<link rel="canonical" href="/blog/2016/12/26/accumulating-merge-sort.html">




<script type="application/ld+json">
  {
    "@context": "https://schema.org",
    
      "@type": "Person",
      "name": null,
      "url": "/"
    
  }
</script>







<!-- end _includes/seo.html -->



  <link href="/feed.xml" type="application/atom+xml" rel="alternate" title="Double Ended Queue Feed">


<!-- https://t.co/dKP3o1e -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">
<!--<link rel="stylesheet" href="/assets/css/overrides.css">-->
<link rel="preload" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5/css/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
<noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5/css/all.min.css"></noscript>

<!-- highlight.js support -->
<!--<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.8/styles/idea.min.css"/>-->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.8/styles/github.min.css"/>
<!--<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.8/styles/default.min.css">-->
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.8/highlight.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.8/languages/clojure.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.8/languages/cpp.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.8/languages/elixir.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.8/languages/haskell.min.js"></script>
<!--<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.8/languages/idris.min.js"></script>-->
<script>hljs.initHighlightingOnLoad();</script>
<!-- end highlight.js support -->

<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jpswalsh/academicons@1/css/academicons.min.css">


  <script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        TeX: {
          equationNumbers: {
            autoNumber: "AMS"
          }
        },
        tex2jax: {
        inlineMath: [ ['$', '$'] ],
        displayMath: [ ['$$', '$$'] ],
        processEscapes: true,
      }
    });
    MathJax.Hub.Register.MessageHook("Math Processing Error",function (message) {
          alert("Math Processing Error: "+message[1]);
        });
    MathJax.Hub.Register.MessageHook("TeX Jax - parse error",function (message) {
          alert("Math Processing Error: "+message[1]);
        });
    </script>
<script type="text/javascript" async src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-MML-AM_CHTML">
</script>



    <!-- start custom head snippets -->

<!-- insert favicons. use https://realfavicongenerator.net/ -->

<!-- end custom head snippets -->

  </head>

  <body class="layout--post">
    <nav class="skip-links">
  <ul>
    <li><a href="#site-nav" class="screen-reader-shortcut">Skip to primary navigation</a></li>
    <li><a href="#main" class="screen-reader-shortcut">Skip to content</a></li>
    <li><a href="#footer" class="screen-reader-shortcut">Skip to footer</a></li>
  </ul>
</nav>

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->

    
        

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
        <a class="site-title" href="/blog">
          Double Ended Queue
          <span class="site-subtitle">Functions In, Fictions Out</span>
        </a>
        <ul class="visible-links"><li class="masthead__menu-item">
              <a href="/">About</a>
            </li><li class="masthead__menu-item">
              <a href="/archives/">Archives</a>
            </li><li class="masthead__menu-item">
              <a href="/categories/">Categories</a>
            </li></ul>
        
        <button class="search__toggle" type="button">
          <span class="visually-hidden">Toggle search</span>
          <i class="fas fa-search"></i>
        </button>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">Toggle menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>
    

    <div class="initial-content">
      



<div id="main" role="main">
  
  <div class="sidebar sticky">
  
  
    
      
      
      
      
    
      
      
      
      
    
      
      
      
      
    
      
      
      
      
    
    
    
      <!--Future idea to search on the side bar-->
<!--
<button class="search__toggle" type="button">
    <span class="visually-hidden">Toggle search</span>
    <i class="fas fa-search"></i>
</button>
-->

<nav class="nav__list">
    <ul class="nav__items">
        <li>
            <span class="nav__sub-title">Recent posts</span>
            <ul>
                
                    <li class="sidebar__item"><a href="/blog/2022/09/05/statistical-gender-bias.html">Statistical gender bias</a></li>
                
                    <li class="sidebar__item"><a href="/blog/2022/06/19/perplexity.html">Understanding perplexity and its relation to cross-entropy and compression</a></li>
                
                    <li class="sidebar__item"><a href="/blog/2022/06/16/lm-joint-probability.html">Auto-regressive language models don't necessarily sample the most probable sentences</a></li>
                
                    <li class="sidebar__item"><a href="/blog/2022/05/24/cycling-drag-force.html">How wind affects your speed on a bike</a></li>
                
            </ul>
        </li>
    </ul>
</nav>
    
    
      <nav class="nav__list">
    <ul class="nav__items">
        <li>
            <span class="nav__sub-title">Categories</span>
            <ul>
                
                    
                    <li class="sidebar__item"><a href="/categories/#functional-programming">functional-programming</a></li>
                
                    
                    <li class="sidebar__item"><a href="/categories/#modern-cpp">modern-cpp</a></li>
                
                    
                    <li class="sidebar__item"><a href="/categories/#software-design">software-design</a></li>
                
                    
                    <li class="sidebar__item"><a href="/categories/#system-design">system-design</a></li>
                
                    
                    <li class="sidebar__item"><a href="/categories/#random-rambling">random-rambling</a></li>
                
                    
                    <li class="sidebar__item"><a href="/categories/#machine-learning">machine-learning</a></li>
                
            </ul>
        </li>
    </ul>
</nav>
    
    
      <nav class="nav__list">
    <ul class="nav__items">
        <li>
            <span class="nav__sub-title">Contact info</span>
            <ul class="author__urls social-icons">
                <li><a href="/" rel="nofollow noopener noreferrer"><i class="fas fa-fw fa-link" aria-hidden="true"></i><span class="label">Website</span></a></li>
                <li><a href="https://github.com/QuentinDuval" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-github" aria-hidden="true"></i><span class="label">GitHub</span></a></li>
                <li><a href="https://scholar.google.com/citations?user=XTaVGqYAAAAJ" rel="nofollow noopener noreferrer"><i class="ai ai-google-scholar-square" aria-hidden="true"></i><span class="label">Google Scholar</span></a></li>
                <li><a href="https://twitter.com/quduval" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-twitter-square" aria-hidden="true"></i><span class="label">Twitter</span></a></li>
                <li><a href="https://www.linkedin.com/in/quentin-duval-53ba6576" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-linkedin" aria-hidden="true"></i><span class="label">LinkedIn</span></a></li>
            </ul>
        </li>
    </ul>
</nav>
    
    
  
  </div>


  <article class="page" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="Accumulating merge sort (C++)">
    <meta itemprop="description" content="Implementing a merge sort in terms of a std::accumulate (left to right scan) is possible. Here is how to merge sort using only ForwardIterators.">
    <meta itemprop="datePublished" content="2016-12-26T00:00:00+00:00">
    

    <div class="page__inner-wrap">
      
        <header>
          <h1 id="page-title" class="page__title" itemprop="headline">Accumulating merge sort (C++)
</h1>
          

  <p class="page__meta">
    
      
      <span class="page__meta-date">
        <i class="far fa-calendar-alt" aria-hidden="true"></i>
        
        <time datetime="2016-12-26T00:00:00+00:00">December 26, 2016</time>
      </span>
    

    

    <!--
    <span class="page__meta-sep"></span>
    <span>Quentin Duval</span>
    -->

    
  </p>



    




<span id="share-buttons-light-prompt" style="color: silver;">Share on: </span>
<div id="share-buttons-light">
    <div class="twitter"  title="Share this on Twitter"     onclick="window.open('https://twitter.com/intent/tweet?url=%2Fblog%2F2016%2F12%2F26%2Faccumulating-merge-sort.html&text=Accumulating+merge+sort+%28C%2B%2B%29&via=','popup','width=600,height=600'); return false;">
        <!--<svg viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg"><path d="M1684 408q-67 98-162 167 1 14 1 42 0 130-38 259.5t-115.5 248.5-184.5 210.5-258 146-323 54.5q-271 0-496-145 35 4 78 4 225 0 401-138-105-2-188-64.5t-114-159.5q33 5 61 5 43 0 85-11-112-23-185.5-111.5t-73.5-205.5v-4q68 38 146 41-66-44-105-115t-39-154q0-88 44-163 121 149 294.5 238.5t371.5 99.5q-8-38-8-74 0-134 94.5-228.5t228.5-94.5q140 0 236 102 109-21 205-78-37 115-142 178 93-10 186-50z"/></svg>-->
        <span class="fab fa-fw fa-twitter share-light share-light-twitter"></span>
    </div>
    <div class="facebook" title="Share this on Facebook"    onclick="window.open('http://www.facebook.com/share.php?u=%2Fblog%2F2016%2F12%2F26%2Faccumulating-merge-sort.html','popup','width=600,height=600'); return false;">
        <!--<svg viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg"><path d="M1343 12v264h-157q-86 0-116 36t-30 108v189h293l-39 296h-254v759h-306v-759h-255v-296h255v-218q0-186 104-288.5t277-102.5q147 0 228 12z"/></svg>-->
        <span class="fab fa-fw fa-facebook share-light share-light-facebook"></span>
    </div>
    <div class="linkedin" title="Share this on Linkedin"    onclick="window.open('https://www.linkedin.com/sharing/share-offsite/?url=%2Fblog%2F2016%2F12%2F26%2Faccumulating-merge-sort.html','popup','width=600,height=600'); return false;">
        <!--<svg viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg"><path d="M477 625v991h-330v-991h330zm21-306q1 73-50.5 122t-135.5 49h-2q-82 0-132-49t-50-122q0-74 51.5-122.5t134.5-48.5 133 48.5 51 122.5zm1166 729v568h-329v-530q0-105-40.5-164.5t-126.5-59.5q-63 0-105.5 34.5t-63.5 85.5q-11 30-11 81v553h-329q2-399 2-647t-1-296l-1-48h329v144h-2q20-32 41-56t56.5-52 87-43.5 114.5-15.5q171 0 275 113.5t104 332.5z"/></svg>-->
        <span class="fab fa-fw fa-linkedin share-light share-light-linkedin"></span>
    </div>
    <a class="reddit" title="Share this on Reddit" href="http://www.reddit.com/submit?url=/blog/2016/12/26/accumulating-merge-sort.html&title=Accumulating merge sort (C++)"
        onclick="gtag('event', 'Reddit', {'event_category':'Post Shared','event_label':'Reddit'}); window.open(this.href, 'pop-up', 'left=20,top=20,width=900,height=500,toolbar=1,resizable=0'); return false;">
        <span class="fab fa-fw fa-reddit share-light share-light-reddit"></span>
    </a>

    <a title="Share this on Hacker News"
        href="http://news.ycombinator.com/submitlink?u=/blog/2016/12/26/accumulating-merge-sort.html&t=Accumulating merge sort (C++)">
        <span class="fab fa-fw fa-hacker-news share-light share-light-hacker-news"></span>
    </a>
</div>


        </header>
      

      <section class="page__content" itemprop="text">
        
          <aside class="sidebar__right ">
            <nav class="toc">
              <header><h4 class="nav__title"><i class="fas fa-file-alt"></i> Table of content</h4></header>
              <ul class="toc__menu"><li><a href="#small-ranges-and-binary-counters">Small ranges and binary counters</a></li><li><a href="#impementing-the-binary-counter">Impementing the binary counter</a></li><li><a href="#the-merge-binary-operation">The merge binary operation</a></li><li><a href="#accumulating-with-iterators">Accumulating with iterators</a></li><li><a href="#wrapping-it-up">Wrapping it up</a></li></ul>

            </nav>
          </aside>
        
        <p>Back in September 2016, I was lucky enough to attend a talk from <a href="https://twitter.com/ben_deane">Ben Deane</a> entitled <a href="https://www.youtube.com/watch?v=B6twozNPUoA">std::accumulate: Exploring an Algorithmic Empire</a>. In this talk, he presents the unknown possibilities of <code>std::accumulate</code>, an algorithm also known as fold or reduce depending on the language.</p>

<p>In his talk, he announced he had implemented almost all the algorithms of the STL based on <code>std::accumulate</code> (41st minute in the <a href="https://www.youtube.com/watch?v=B6twozNPUoA">video</a>), including <code>std:stable_sort</code>, which was a bit surprising to me.</p>

<p>So I searched <a href="http://www.elbeno.com/blog/">his blog</a> and could not find a hit on how he did it. So I decided to write this post to describe the solution I found.</p>

<p>The subject of today’s post is therefore to:</p>

<ul>
  <li>Implement this algorithm in C++</li>
  <li>Make it work on the input container directly</li>
  <li>Make it work for more than just lists</li>
</ul>

<p>In the process, we will build a <code>std::stable_sort</code> variant that works for <a href="http://en.cppreference.com/w/cpp/concept/ForwardIterator">ForwardIterators</a>, whereas std::stable_sort only works for <a href="http://en.cppreference.com/w/cpp/algorithm/stable_sort">RandomAccessIterator</a>.</p>

<h2 id="small-ranges-and-binary-counters">Small ranges and binary counters</h2>

<p>The solution relies on using a <strong>binary counter</strong> like data-structure:</p>

<ul>
  <li>Our binary counter will hold at each level $L$ a range of size $2^L$. The binary counter will thus be limited in size to $\log N$ if $N$ is the number of elements of the collection to sort.</li>
  <li>We populate the binary counter by successively adding ranges of size one to the counter.</li>
  <li>Each time we have a collision of “bit” (range of the same size), we merge them and consider it as a “carry”.</li>
  <li>We keep propagating the carry up the levels, until we reach an empty slot.</li>
</ul>

<p>This is best explained by an example:</p>

<pre><code>Initially
Counter = [[1, 2], [3, 4, 5, 6]]
 
Adding element 7
Counter = [[7], [1, 2], [3, 4, 5, 6]]
 
Adding element 8
Counter = [merge [8] and [7], [1, 2], [3, 4, 5, 6]]
Counter = [merge [7, 8] and [1, 2], [3, 4, 5, 6]]
Counter = [merge [1, 2, 7, 8] and [3, 4, 5, 6]]
Counter = [[1, 2, 3, 4, 5, 6, 7, 8]]
 
Adding elements 9, 10 and 11
Counter = [[11], [9, 10], [1, 2, 3, 4, 5, 6, 7, 8]]
</code></pre>

<p>At this point, we are almost done, but not quite. We still need to collapse all the remaining “bits” of our counter into one answer. We do this by accumulating over these “bits” with a merge operation.</p>

<pre><code>[[11], [9, 10], [1, 2, 3, 4, 5, 6, 7, 8]]
[[9, 10, 11], [1, 2, 3, 4, 5, 6, 7, 8]]
[[1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11]]
</code></pre>

<p>We are done! Let us try to implement this in C++.</p>

<h2 id="impementing-the-binary-counter">Impementing the binary counter</h2>

<p>Following a quick youtube search, I was able to find an episode of the <a href="https://www.youtube.com/playlist?list=PLHxtyCq_WDLXryyw91lahwdtpZsmo4BGD">A9 Stepanov lectures</a> that dealt with the implementation of a binary counter in C++.</p>

<p>The following code is greatly inspired (almost copy-pasted, except for the <code>std::find_if</code>) from these amazing lessons:</p>

<ul>
  <li>The <code>add_to_counter</code> function handles the carry propagation, and returns the carry if it ran out of bits</li>
  <li>The <code>reduce_counter</code> allows to collapse all the remaining bits at the end of the accumulation</li>
  <li>The <code>binary_counter</code> class maintains the vector of bits, and is responsible for gluing the algorithms together</li>
</ul>

<pre><code class="language-cpp">template&lt;typename Iterator, typename Value, typename BinaryOp&gt;
Value add_to_counter(Iterator first, Iterator last,
                     Value carry, Value const &amp;zero,
                     BinaryOp op)
{
    assert(carry != zero);
    for (; first != last; ++first) {
        if (*first == zero) {
            *first = carry;
            return zero;
        }
        carry = op(*first, carry);
        *first = zero;
    }
    return carry;
}

template&lt;typename Iterator, typename Value, typename BinaryOp&gt;
Value reduce_counter(Iterator first, Iterator last,
                     Value const &amp;zero, BinaryOp op)
{
    first = std::find_if(first, last, [&amp;zero](auto &amp;v) { return v != zero; });
    if (first == last)
        return zero;

    Value result = *first;
    for (++first; first != last; ++first) {
        if (*first != zero)
            result = op(*first, result);
    }
    return result;
};


template&lt;typename BinaryOp, typename Value&gt;
class binary_counter {
public:
    binary_counter(BinaryOp const &amp;op, Value const &amp;zero)
        : m_bits(), m_zero(zero), m_op(op) {}

    void add(Value carry) {
        carry = add_to_counter(begin(m_bits), end(m_bits), carry, m_zero, m_op);
        if (carry != m_zero)
            m_bits.push_back(std::move(carry));
    }

    Value reduce() const {
        return reduce_counter(begin(m_bits), end(m_bits), m_zero, m_op);
    }

private:
    std::vector&lt;Value&gt; m_bits;
    Value m_zero;
    BinaryOp m_op;
};
</code></pre>

<p>As for the Haskell implementation in our <a href="/blog/2016/12/22/folding-merge-sort.html">previous post</a>, the C++ implementation of the binary counter is able to deal with any Monoid. It only requires:</p>

<ul>
  <li>An associative binary operation</li>
  <li>That admits a neutral element</li>
</ul>

<p>This implementation also shows a great usage of object orientation to structure a program: the class is used to combine some algorithms with the data their operate on (to guaranty invariants), while the algorithms are kept outside of the class for greater re-use.</p>

<h2 id="the-merge-binary-operation">The merge binary operation</h2>

<p>Now that we have a <code>binary_counter</code> that works on any Monoid, we need to define the equivalent of the <code>SortedList</code> Monoid instance on which to apply it.</p>

<ul>
  <li>The neutral element will be the empty range</li>
  <li>The binary operation will be something close to <code>std::merge</code>.</li>
</ul>

<p>Why something close and not <code>std::merge</code> directly? Because we need some kind of auxiliary buffer to perform the merge.</p>

<p>This is the implementation I came to:</p>

<pre><code class="language-cpp">template&lt;typename Iterator&gt;
struct merger
{
    using Value = typename std::iterator_traits&lt;Iterator&gt;::value_type;
    using SortedRange = std::pair&lt;Iterator, Iterator&gt;;

    SortedRange operator()(SortedRange const &amp;lhs, SortedRange const &amp;rhs) const {
        assert(lhs.second == rhs.first);
        std::vector&lt;Value&gt; tmp(lhs.first, lhs.second); //Copy the left range
        std::merge(
                std::begin(tmp), std::end(tmp), // Left container copy (source)
                rhs.first, rhs.second,          // Right container (source)
                lhs.first);                     // Left container (destination)
        return SortedRange(lhs.first, rhs.second);
    }
};
</code></pre>

<p>I found this implementation more tricky than I first thought it would be. In particular, we need to ensure that the two ranges we merge are always:</p>

<ul>
  <li>Next to each other (one range end is the beginning of the other)</li>
  <li>In the right order (left range is before the right range)</li>
</ul>

<p>I claim these two propositions will always hold if we accumulate our container from left to right. The argument is based on the implementation of <code>add_to_counter</code> and <code>reduce_counter</code> and the properties of Monoids.</p>

<p>Indeed, <code>reduce_counter</code> initializes its result from the lower level “bit” (which is the latest arrived in the counter) and combines it on the right with <code>op(*first, result)</code>. So the latest arrived range is always provided as right argument of the merge operation.</p>

<p>The same goes for <code>add_to_counter</code> that combines the carry on the right side of the binary operation. Again, the latest arrived range is provided as right argument of the merge operation.</p>

<p>This property of the <code>binary_counter</code> algorithm is crucial. The Monoid property guaranties our operation is associative but not necessarily commutative. So the <code>binary_counter</code> must have this property to be correct, and as a result we can rely on it.</p>

<h2 id="accumulating-with-iterators">Accumulating with iterators</h2>

<p>It is now time to combine our different elements to build our std::stable_sort based on a <code>std::accumulate</code>. But there is a catch…</p>

<p>As observed by Ben Deane in <a href="https://www.youtube.com/watch?v=B6twozNPUoA">std::accumulate: Exploring an Algorithmic Empire</a>, we cannot really use the std::accumulate of the STL here. It deals with values while we need ranges here, which means iterators.</p>

<p>An easy way to get past this is to create our own <code>accumulate_iter</code> algorithm, that provides an iterator to the accumulating function (instead of a value):</p>

<pre><code class="language-cpp">template&lt;typename Iterator, typename Value, typename Accumulator&gt;
Value accumulate_iter(Iterator first, Iterator last,
                      Value val, Accumulator fct)
{
    for (; first != last; ++first)
        val = fct(val, first);
    return val;
};
</code></pre>

<p>Based on this algorithm, we are now able to assemble the different parts needed to build a <code>std:stable_sort</code> working on <code>ForwardIterators</code>:</p>

<pre><code class="language-cpp">template&lt;typename ForwardIterator&gt;
void stable_sort_forward(ForwardIterator first, ForwardIterator last)
{
    using Range = std::pair&lt;ForwardIterator, ForwardIterator&gt;;
    using Counter = binary_counter&lt;merger&lt;ForwardIterator&gt;, Range&gt;;
  
    Counter c { merger&lt;ForwardIterator&gt;{}, { last, last } };
    accumulate_iter(first, last, &amp;c,
                    [](auto c, auto it) {
                        c-&gt;add({it, std::next(it)});
                        return c;
                    })-&gt;reduce();
}
</code></pre>

<p>Now we are truly done. You can convince yourself that it does stable sort a container by trying it on some examples.</p>

<h2 id="wrapping-it-up">Wrapping it up</h2>

<p>We managed to write a <code>std::stable_sort</code> using a variant of <code>std::accumulate</code> that sorts a container provided as parameter. I do not know if this is the same solution Ben Deane used to implement his own, but it is definitively doable.</p>

<p>One interesting consequence is that our stable sort algorithm also works for <code>ForwardIterator</code>. So you can sort a <code>std::list</code> and even a <code>std::forward_list</code> with it.</p>

<p>Now, I would not be offended if you told me you found <code>accumulate_iter</code> usage neither beautiful, nor concise, nor simple. If you do, you might be more interested in this version of the algorithm, where we use a raw loop:</p>

<pre><code class="language-cpp">template&lt;typename ForwardIterator&gt;
void stable_sort_forward(ForwardIterator first, ForwardIterator last)
{
    using Range = std::pair&lt;ForwardIterator, ForwardIterator&gt;;
    using Counter = binary_counter&lt;merger&lt;ForwardIterator&gt;, Range&gt;;

    Counter c { merger&lt;ForwardIterator&gt;{}, { last, last } };
    for (; first != last; ++first) {
        c.add(std::make_pair(first, std::next(first)));
    }
    c.reduce();
}
</code></pre>

<p>It gives the same results, so it is mostly a matter of taste here. Indeed, C++ may not be the best language to play with fold algorithms. You might prefer the imperative style when programming in C++. Ultimately, deciding which tool and which paradigm to use is a choice you and your team have to make.</p>


        
      </section>

      <footer class="page__meta">
        
        


        

  <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> Updated:</strong> <time datetime="2016-12-26T00:00:00+00:00">December 26, 2016</time></p>


      </footer>

      <section class="page__share">
    
  
    <a href="https://twitter.com/intent/tweet?via=quduval&text=Accumulating+merge+sort+%28C%2B%2B%29%20%2Fblog%2F2016%2F12%2F26%2Faccumulating-merge-sort.html" class="btn btn--twitter" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Twitter"><i class="fab fa-fw fa-twitter" aria-hidden="true"></i><span> Twitter</span></a>
  
    <a href="https://www.facebook.com/sharer/sharer.php?u=%2Fblog%2F2016%2F12%2F26%2Faccumulating-merge-sort.html" class="btn btn--facebook" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Facebook"><i class="fab fa-fw fa-facebook" aria-hidden="true"></i><span> Facebook</span></a>
  
    <!--
    <a href="https://www.linkedin.com/shareArticle?mini=true&url=%2Fblog%2F2016%2F12%2F26%2Faccumulating-merge-sort.html" class="btn btn--linkedin" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on LinkedIn"><i class="fab fa-fw fa-linkedin" aria-hidden="true"></i><span> LinkedIn</span></a>
    -->
    
    <a href="https://www.reddit.com/submit?url=%2Fblog%2F2016%2F12%2F26%2Faccumulating-merge-sort.html&title=Accumulating+merge+sort+%28C%2B%2B%29" class="btn" style="background-color: #ff4500; color: white" title=" Reddit"><i class="fab fa-fw fa-reddit" aria-hidden="true"></i><span> Reddit</span></a>

    <a href="http://news.ycombinator.com/submitlink?u=%2Fblog%2F2016%2F12%2F26%2Faccumulating-merge-sort.html&t=Accumulating merge sort (C++)" class="btn" style="background-color: #ff6600; color: white"  title=" Hackernews"><i class="fab fa-fw fa-hacker-news" aria-hidden="true"></i><span> Hacker News</span></a>

</section>

      
<div class="post_navi_hr">&nbsp;</div>
<hr class="post_navi_hr">
<div class="post_navi"><a class="post_navi-item nav_prev" href="/blog/2016/12/22/folding-merge-sort.html" title="Folding merge sort (Haskell)">
    <div class="post_navi-arrow">&lt;</div><div class="post_navi-label">Previous Post</div><div><span class="post_navi-title">Folding merge sort (Haskell)</span></div>
  </a><a class="post_navi-item nav_next" href="/blog/2016/12/31/tdd-meetup-report.html" title="Meetup Report: Better tests Kata night">
    <div class="post_navi-arrow">&gt;</div><div class="post_navi-label">Next Post</div><div><span class="post_navi-title">Meetup Report: Better tests Kata night</span></div>
  </a></div>

    </div>

    
      <div class="page__comments">
  
  
      <h4 class="page__comments-title">Comments</h4>
      <section id="giscus-comments"></section>
    
</div>

    
  </article>

  
  
    <div class="page__related">
      <h4 class="page__related-title">You May Also Enjoy</h4>
      <div class="grid__wrapper">
        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/blog/2022/09/05/statistical-gender-bias.html" rel="permalink">Statistical gender bias
</a>
      
    </h2>
    
        <p class="archive__item-excerpt" itemprop="description">I recently stumbled on a debate where J. Peterson argues that the gender pay gap is mostly not due to gender bias. Let’s see what’s wrong with his argument.
</p>
    
    
<p class="page__meta">

  
    
    <span class="page__meta-date">
      <i class="far fa-calendar-alt" aria-hidden="true"></i>
      
      <time datetime="2022-09-05T00:00:00+00:00">September 5, 2022</time>
      
        &bull; random-rambling
      
    </span>
  

  

  
</p>

  </article>
</div>
        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/blog/2022/06/19/perplexity.html" rel="permalink">Understanding perplexity and its relation to cross-entropy and compression
</a>
      
    </h2>
    
        <p class="archive__item-excerpt" itemprop="description">Modern conditional and unconditional language models often report their perplexity as validation metrics. Let’s see what it means.
</p>
    
    
<p class="page__meta">

  
    
    <span class="page__meta-date">
      <i class="far fa-calendar-alt" aria-hidden="true"></i>
      
      <time datetime="2022-06-19T00:00:00+00:00">June 19, 2022</time>
      
        &bull; machine-learning
      
    </span>
  

  

  
</p>

  </article>
</div>
        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/blog/2022/06/16/lm-joint-probability.html" rel="permalink">Auto-regressive language models don’t necessarily sample the most probable sentences
</a>
      
    </h2>
    
        <p class="archive__item-excerpt" itemprop="description">Have you even tried to sample greedily from a language model. It’s not a good idea. Let’s discuss why.
</p>
    
    
<p class="page__meta">

  
    
    <span class="page__meta-date">
      <i class="far fa-calendar-alt" aria-hidden="true"></i>
      
      <time datetime="2022-06-16T00:00:00+00:00">June 16, 2022</time>
      
        &bull; machine-learning
      
    </span>
  

  

  
</p>

  </article>
</div>
        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/blog/2022/05/24/cycling-drag-force.html" rel="permalink">How wind affects your speed on a bike
</a>
      
    </h2>
    
        <p class="archive__item-excerpt" itemprop="description">Let’s look at how the wind affect your speed on a bike, the diminishing impact of power, and why you feel the drag suddenly passed a certain speed.
</p>
    
    
<p class="page__meta">

  
    
    <span class="page__meta-date">
      <i class="far fa-calendar-alt" aria-hidden="true"></i>
      
      <time datetime="2022-05-24T00:00:00+00:00">May 24, 2022</time>
      
        &bull; random-rambling
      
    </span>
  

  

  
</p>

  </article>
</div>
        
      </div>
    </div>
  
  
</div>

    </div>

    
      <div class="search-content">
        <div class="search-content__inner-wrap"><form class="search-content__form" onkeydown="return event.key != 'Enter';">
    <label class="sr-only" for="search">
      Enter your search term...
    </label>
    <input type="search" id="search" class="search-input" tabindex="-1" placeholder="Enter your search term..." />
  </form>
  <div id="results" class="results"></div></div>

      </div>
    

    <div id="footer" class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        <div class="page__footer-follow">
  <ul class="social-icons">
    

    
      
        
          <li><a href="https://github.com/QuentinDuval" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-github" aria-hidden="true"></i> GitHub</a></li>
        
      
        
          <li><a href="https://twitter.com/quduval" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-twitter-square" aria-hidden="true"></i> Twitter</a></li>
        
      
        
          <li><a href="https://www.linkedin.com/in/quentin-duval-53ba6576/" rel="nofollow noopener noreferrer"><i class="fab fa-linkedin" aria-hidden="true"></i> LinkedIn</a></li>
        
      
    

    
      <li><a href="/feed.xml"><i class="fas fa-fw fa-rss-square" aria-hidden="true"></i> Feed</a></li>
    
  </ul>
</div>

<div class="page__footer-copyright">&copy; 2022 Double Ended Queue. Powered by <a href="https://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://mademistakes.com/work/minimal-mistakes-jekyll-theme/" rel="nofollow">Minimal Mistakes</a>.</div>

      </footer>
    </div>

    
  <script src="/assets/js/main.min.js"></script>




<script src="/assets/js/lunr/lunr.min.js"></script>
<script src="/assets/js/lunr/lunr-store.js"></script>
<script src="/assets/js/lunr/lunr-en.js"></script>




  <script>
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'G-RRHHYN266B']);
  
    _gaq.push(['_gat._anonymizeIp']);
  
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>






    <script>
  'use strict';

  (function () {
    var commentContainer = document.querySelector('#giscus-comments');

    if (!commentContainer) {
      return;
    }

    var script = document.createElement('script');
    script.setAttribute('src', 'https://giscus.app/client.js');
    script.setAttribute('data-repo', 'quentinduval/quentinduval.github.io');
    script.setAttribute('data-repo-id', 'MDEwOlJlcG9zaXRvcnk3MzUyMDE3Nw==');
    script.setAttribute('data-category', 'General');
    script.setAttribute('data-category-id', 'DIC_kwDOBGHUMc4CBKf3');
    script.setAttribute('data-mapping', 'url');
    script.setAttribute('data-reactions-enabled', '1');
    script.setAttribute('data-theme', 'light');
    script.setAttribute('crossorigin', 'anonymous');

    commentContainer.appendChild(script);
  })();
</script>
  





  </body>
</html>
